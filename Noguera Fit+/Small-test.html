<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NogueraFit</title>
    
    <link rel="apple-touch-icon" href="images/icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- iOS DESIGN SYSTEM --- */
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-gray: #F2F2F7;
            --ios-gold: #FFD700;
            --text-dark: #1C1C1E;
            --text-light: #8E8E93;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F2F7;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
        }

        .app-content {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 120px;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .user-select-btn { background: none; border: none; font-size: 18px; font-weight: 700; color: var(--ios-blue); display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 0; }
        .btn-barcode { background: #E5E5EA; border: none; padding: 6px 12px; border-radius: 14px; font-size: 13px; font-weight: 700; color: #555; cursor: pointer; display: flex; align-items: center; gap: 4px; }

        /* --- SWIPEABLE CALENDAR --- */
        .calendar-header {
            background: #fff;
            padding: 15px 0 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            border-radius: 0 0 24px 24px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04);
        }
        .calendar-strip {
            display: flex;
            overflow-x: auto;
            gap: 12px;
            padding: 0 20px;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .calendar-strip::-webkit-scrollbar { display: none; }
        
        .cal-day {
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 70px;
            border-radius: 25px;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: pointer;
            position: relative;
            background: #F9F9F9;
            border: 1px solid transparent;
        }
        .cal-day.active {
            background: var(--ios-blue);
            color: white;
            box-shadow: 0 8px 20px rgba(0,122,255,0.25);
            transform: translateY(-2px);
        }
        .cal-day.future { opacity: 0.3; pointer-events: none; background: none; }
        .cal-day .day-name { font-size: 11px; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; opacity: 0.7; }
        .cal-day .day-num { font-size: 20px; font-weight: 800; }
        
        /* Updated Cal Dot logic handled in JS/CSS below */
        .cal-dot {
            width: 6px; height: 6px; 
            background: var(--ios-green); 
            border-radius: 50%; 
            position: absolute; bottom: 8px;
            display: none; 
        }
        /* Only show dot if .has-data is present */
        .cal-day.has-data .cal-dot { display: block; }
        .cal-day.active .cal-dot { background: white; }

        /* --- CAROUSEL CARDS --- */
        .carousel-track { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding-bottom: 10px; margin: 0 -15px; padding: 0 15px 20px 15px; -ms-overflow-style: none; scrollbar-width: none; }
        .carousel-track::-webkit-scrollbar { display: none; }
        .card-slide { flex: 0 0 92%; scroll-snap-align: center; background: white; border-radius: 24px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.06); position: relative; border: 1px solid rgba(0,0,0,0.02); overflow: hidden; min-height: 380px; }
        
        .score-card-bg::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px; background-color: #007AFF; z-index:1; }
        .stats-card-bg::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px; background-color: var(--ios-green); z-index:1; }
        .leaderboard-bg::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 6px; background-color: var(--ios-gold); z-index:1; }
        
        .scorecard-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; position: relative; z-index: 2; margin-top: 5px; }
        .scorecard-title { font-size: 22px; font-weight: 800; color: #1C1C1E; }
        .scorecard-date { font-size: 12px; color: var(--ios-blue); font-weight: 700; text-transform: uppercase; background: rgba(0,122,255,0.1); padding: 4px 10px; border-radius: 20px; }
        
        .past-banner { 
            background: #FF9500; color: white; text-align: center; 
            font-size: 12px; font-weight: 700; padding: 6px; 
            border-radius: 8px; margin-bottom: 15px; display: none; 
        }

        .score-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 6px 0; border-bottom: 1px dashed #F2F2F7; font-size: 15px; }
        .score-row:last-of-type { border-bottom: none; }
        .score-label { font-weight: 600; color: #666; display: flex; align-items: center; gap: 6px; }
        .score-val { font-weight: 700; color: #1C1C1E; }
        .score-val.done { color: var(--ios-green); }
        
        .btn-sync { width: 100%; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 700; border: none; cursor: pointer; margin-top: 15px; transition: 0.2s; background-color: #E5E5EA; color: var(--ios-blue); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-sync:active { background-color: #D1D1D6; }
        .btn-sync.synced { background-color: var(--ios-green); color: white; }

        .btn-edit-past { width: 100%; padding: 14px; background: white; border: 2px solid #FF9500; color: #FF9500; font-weight: 700; border-radius: 14px; margin-top: 10px; cursor: pointer; display: none; }

        /* --- STATS & LEADERBOARD --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-box { background: #F9F9F9; padding: 15px; border-radius: 16px; text-align: center; display: flex; flex-direction: column; justify-content: center; }
        .stat-val { font-size: 26px; font-weight: 800; color: var(--ios-blue); line-height: 1.1; }
        .stat-label { font-size: 11px; color: var(--text-light); margin-top: 5px; font-weight: 500; text-transform: uppercase; }

        .top-workouts-container { background: #F9F9F9; border-radius: 18px; padding: 20px; }
        .top-header { font-size: 14px; font-weight: 700; margin-bottom: 12px; color: var(--text-dark); text-transform: uppercase; opacity: 0.6; }
        .top-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #e0e0e0; }
        .top-item:last-child { border-bottom: none; }
        .top-name { font-size: 15px; color: var(--text-dark); font-weight: 600; }
        .top-count { background: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; color: var(--text-light); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .lb-headers { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: #8E8E93; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #F2F2F7; padding-bottom: 5px; margin-top: 20px; }
        .lb-list { max-height: 250px; overflow-y: auto; }
        .lb-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F2F2F7; }
        .lb-rank { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: 800; border-radius: 50%; font-size: 13px; margin-right: 8px; }
        .rank-1 { background: #FFD700; color: #B48902; } .rank-2 { background: #C0C0C0; color: #555; } .rank-3 { background: #CD7F32; color: #6A3906; } .rank-low { background: #F2F2F7; color: #8E8E93; font-size: 11px; }
        .lb-details { display: flex; flex-direction: column; }
        .lb-name { font-weight: 700; font-size: 15px; color: #1C1C1E; }
        .lb-sub { font-size: 11px; color: #8E8E93; font-weight: 500; }
        .lb-stat-box { text-align: right; }
        .lb-val-main { font-weight: 800; font-size: 16px; color: #1C1C1E; }
        .lb-val-sub { font-size: 11px; color: var(--ios-blue); font-weight: 600; }

        /* --- TABS & WORKOUT UI --- */
        .tab-bar { display: flex; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); padding: 5px; gap: 5px; position: sticky; top: 10px; z-index: 90; margin-bottom: 20px; border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; text-align: center; font-weight: 700; font-size: 13px; cursor: pointer; color: var(--text-light); transition: all 0.2s; }
        .tab-btn.active { background: white; color: var(--text-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #tab-workout.active { color: var(--ios-blue); }
        #tab-nutrition.active { color: var(--ios-green); }

        .read-only-mask { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }

        .big-add-btn { background: white; border: 2px dashed #D1D1D6; border-radius: 20px; padding: 30px; text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 10px; color: #8E8E93; width: 100%; margin-bottom: 20px; }
        .big-add-btn:active { background: #F2F2F7; border-color: var(--ios-blue); color: var(--ios-blue); }
        .big-icon { font-size: 32px; display: block; margin-bottom: 5px; }

        .exercise-card { background: white; border-radius: 18px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.04); animation: slideIn 0.3s ease-out; position: relative; }
        .exercise-img { width: 100%; height: 200px; object-fit: contain; background-color: white; padding: 10px; border-bottom: 1px solid #F2F2F7; }
        .exercise-details { padding: 18px; }
        .exercise-name { font-size: 18px; font-weight: 800; margin-bottom: 6px; color: #1C1C1E; }
        .exercise-instruction { background-color: #F0F8FF; color: var(--ios-blue); padding: 8px 12px; border-radius: 8px; font-size: 14px; font-weight: 600; display: inline-block; }
        .btn-remove-card { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.05); border: none; width: 32px; height: 32px; border-radius: 50%; color: #FF3B30; font-weight: bold; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }

        .btn-add-more { background: white; color: var(--ios-blue); border: 1px solid var(--ios-blue); width: 100%; padding: 14px; border-radius: 14px; font-weight: 700; margin-bottom: 10px; cursor: pointer; font-size: 15px; }

        /* --- HISTORY LIST --- */
        .history-container { margin-top: 30px; border-top: 1px solid #E5E5EA; padding-top: 20px; }
        .history-title { font-size: 14px; font-weight: 700; color: #8E8E93; text-transform: uppercase; margin-bottom: 10px; }
        .history-item { background: white; padding: 12px 16px; border-radius: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 14px; font-weight: 600; }
        .btn-undo { color: #FF3B30; font-weight: 700; border: none; background: none; cursor: pointer; padding: 5px; font-size: 16px; }

        /* --- HABITS --- */
        .hidden-view { display: none !important; }
        .habit-card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .habit-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
        .habit-title { font-weight: 700; font-size: 16px; }
        .habit-count { font-size: 14px; font-weight: 600; color: #888; background: #f2f2f7; padding: 3px 8px; border-radius: 6px; }
        .habit-bar-bg { height: 8px; background: #F2F2F7; border-radius: 4px; overflow: hidden; margin-bottom: 12px; }
        .habit-bar-fill { height: 100%; width: 0%; border-radius: 4px; transition: 0.3s; }
        .circle-row { display: flex; gap: 8px; }
        .habit-circle { width: 26px; height: 26px; border-radius: 50%; border: 2px solid #E5E5EA; cursor: pointer; transition: 0.2s; }
        .habit-circle.active { transform: scale(1.1); border-color: transparent; }
        .bg-water { background: #5AC8FA; } .bg-veggie { background: #34C759; } .bg-fruit { background: #FF3B30; } .bg-snack { background: #AF52DE; }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-content { background: #F2F2F7; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 25px; height: 80vh !important; max-height: none !important; display: flex; flex-direction: column; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0; }
        .modal-title { font-size: 20px; font-weight: 800; }
        .btn-close { background: #E5E5EA; border: none; width: 30px; height: 30px; border-radius: 50%; color: #555; font-weight: bold; cursor: pointer; }
        .modal-tabs { display: flex; background: #E5E5EA; border-radius: 10px; padding: 3px; margin-bottom: 15px; flex-shrink: 0; }
        .modal-tab { flex: 1; text-align: center; padding: 8px; font-size: 13px; font-weight: 700; color: #8E8E93; border-radius: 8px; cursor: pointer; }
        .modal-tab.active { background: white; color: black; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .filter-section-title { font-size: 12px; font-weight: 700; color: #8E8E93; margin: 15px 0 8px 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; flex-shrink: 0; -webkit-overflow-scrolling: touch; }
        .loc-chip, .cat-chip, .focus-chip { padding: 10px 16px; border: none; background: white; border-radius: 20px; font-weight: 600; font-size: 14px; white-space: nowrap; color: #8E8E93; cursor: pointer; border: 1px solid transparent; transition: 0.1s; }
        .loc-chip.active, .cat-chip.active, .focus-chip.active { background: var(--ios-blue); color: white; box-shadow: 0 4px 12px rgba(0,122,255,0.3); }
        .select-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        .select-item { background: white; padding: 10px 20px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.1s; min-height: 80px; }
        .select-item.selected { background: #E3F2FD; border: 1px solid var(--ios-blue); }
        .select-left { display: flex; align-items: center; gap: 15px; flex: 1; }
        .select-check { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #D1D1D6; display: flex; align-items: center; justify-content: center; color: transparent; flex-shrink: 0; }
        .select-item.selected .select-check { background: var(--ios-blue); border-color: var(--ios-blue); color: white; font-size: 16px; }
        .select-name { font-weight: 700; font-size: 16px; line-height: 1.3; }
        .no-equip-tag { font-size: 11px; background: #E5E5EA; color: #555; padding: 3px 6px; border-radius: 6px; margin-left: 6px; font-weight: 600; white-space: nowrap; }
        .select-img { width: 80px; height: 60px; object-fit: contain; margin-left: 10px; mix-blend-mode: multiply; }
        .btn-confirm-add { width: 100%; padding: 18px; background: var(--ios-blue); color: white; font-weight: 700; border-radius: 16px; border: none; margin-top: 15px; cursor: pointer; font-size: 16px; flex-shrink: 0; }
        .gen-section { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; }
        .gen-label { font-size: 13px; font-weight: 700; color: #8E8E93; margin-bottom: 10px; text-transform: uppercase; }
        .slider-container { display: flex; align-items: center; gap: 15px; }
        input[type=range] { flex: 1; }
        .slider-val { font-weight: 800; font-size: 20px; width: 30px; text-align: center; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .dots-indicator { display:flex; justify-content:center; gap:8px; margin-bottom:25px; margin-top:-10px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #D1D1D6; transition: 0.2s; }
        .dot.active { background: var(--ios-blue); transform: scale(1.2); }

        /* --- SKELETON LOADING ANIMATION --- */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes pulse { 
            from { opacity: 0.5; transform: scale(0.8); } 
            to { opacity: 1; transform: scale(1); } 
        }
        /* Generic Skeleton Bar */
        .skeleton-text {
            background: linear-gradient(90deg, #F2F2F7 25%, #E5E5EA 50%, #F2F2F7 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: 6px;
            color: transparent !important;
            display: inline-block;
            height: 14px;
            width: 100%;
        }
        /* The Ghost Dot (Loading state for calendar) */
        .cal-skeleton-dot {
            width: 6px; height: 6px;
            background: #E5E5EA; /* Light gray */
            border-radius: 50%;
            position: absolute; bottom: 8px;
            display: block;
            animation: pulse 0.8s infinite alternate;
        }
    </style>
</head>
<body>

    <div class="app-content">
        <div class="top-nav">
            <button class="user-select-btn" onclick="openUserModal()">
                <span id="header-username">üë• Select Team</span> <span>‚ñº</span>
            </button>
            <button class="btn-barcode" onclick="openBarcode()">Gym Pass</button>
        </div>

        <div class="calendar-header">
            <div style="text-align: center; margin-bottom: 12px;">
                <span id="header-month-title" style="font-size: 17px; font-weight: 700; color: var(--text-dark); letter-spacing: -0.5px;">February 2026</span>
            </div>
            <div class="calendar-strip" id="calendar-strip"></div>
        </div>

        <div class="carousel-track" id="carousel-track">
            
            <div class="card-slide score-card-bg">
                <div class="scorecard-header">
                    <div class="scorecard-title" id="score-title">Scorecard</div>
                    <div class="scorecard-date" id="score-card-date-badge">Today</div>
                </div>
                
                <div id="past-view-banner" class="past-banner">üìÖ Viewing Past Record</div>

                <div class="score-row">
                    <span class="score-label">üèãÔ∏è Exercise</span>
                    <span class="score-val" id="score-workout">0 Done</span>
                </div>
                <div class="score-row">
                    <span class="score-label">üíß Water</span>
                    <span class="score-val" id="score-water">0 / 8</span>
                </div>
                <div class="score-row">
                    <span class="score-label">ü•¶ Veggies</span>
                    <span class="score-val" id="score-veggies">0 / 5</span>
                </div>
                <div class="score-row">
                    <span class="score-label">üçé Fruits</span>
                    <span class="score-val" id="score-fruits">0 / 5</span>
                </div>
                <div class="score-row">
                    <span class="score-label">ü•ú Snacks</span>
                    <span class="score-val" id="score-snacks">0 / 2</span>
                </div>
                
                <button id="main-action-btn" class="btn-sync" onclick="shareScorecard()">
                    üì§ Share Scorecard
                </button>
                <button id="edit-past-btn" class="btn-edit-past" onclick="enablePastEdit()">
                    ‚úèÔ∏è Edit Past Record
                </button>
            </div>

            <div class="card-slide stats-card-bg" id="stats-slide">
                <div class="scorecard-header">
                    <div class="scorecard-title">Challenge Stats</div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="stat-val" id="stat-days-left">--</span>
                        <span class="stat-label">Days Until June 13</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-val" id="stat-workouts-left">--</span>
                        <span class="stat-label">Workouts to 100</span>
                    </div>
                </div>

                <div class="top-workouts-container">
                    <div class="top-header">Your Top 5 Exercises</div>
                    <div id="top-workouts-list">
                         <div class="top-item"><span class="skeleton-text" style="width:60%"></span><span class="skeleton-text" style="width:20px"></span></div>
                        <div class="top-item"><span class="skeleton-text" style="width:40%"></span><span class="skeleton-text" style="width:20px"></span></div>
                        <div class="top-item"><span class="skeleton-text" style="width:50%"></span><span class="skeleton-text" style="width:20px"></span></div>
                    </div>
                </div>
            </div>

            <div class="card-slide leaderboard-bg">
                <div class="scorecard-header">
                    <div class="scorecard-title">Family Rankings</div>
                    <div class="scorecard-date" onclick="fetchCloudHistory()" style="cursor:pointer; background:#FFF8E1; color:#FF9500;">‚Üª</div>
                </div>
                <div class="lb-headers">
                    <span>Rank / Name</span>
                    <span>Total Days Logged</span>
                </div>
                <div id="lb-container" class="lb-list">
                     <div class="lb-row">
                        <div style="display:flex; align-items:center; width:100%">
                            <div class="skeleton-text" style="width:24px; height:24px; border-radius:50%; margin-right:8px;"></div>
                            <div style="flex:1"><div class="skeleton-text" style="width:40%"></div></div>
                        </div>
                    </div>
                    <div class="lb-row">
                        <div style="display:flex; align-items:center; width:100%">
                            <div class="skeleton-text" style="width:24px; height:24px; border-radius:50%; margin-right:8px;"></div>
                            <div style="flex:1"><div class="skeleton-text" style="width:60%"></div></div>
                        </div>
                    </div>
                    <div class="lb-row">
                        <div style="display:flex; align-items:center; width:100%">
                            <div class="skeleton-text" style="width:24px; height:24px; border-radius:50%; margin-right:8px;"></div>
                            <div style="flex:1"><div class="skeleton-text" style="width:30%"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="dots-indicator">
            <div class="dot active"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>

        <div class="tab-bar">
            <div id="tab-workout" class="tab-btn active" onclick="switchTab('workout')">EXERCISE</div>
            <div id="tab-nutrition" class="tab-btn" onclick="switchTab('nutrition')">NUTRITION</div>
        </div>

        <div id="workout-view">
            <div id="workout-content-area">
                <div id="add-trigger-area" class="big-add-btn" onclick="openBatchSelect()">
                    <span class="big-icon">‚ûï</span>
                    <span style="font-weight:700; font-size:16px; color:#333;">Add Workout</span>
                    <span style="font-size:13px;">Tap to select exercises</span>
                </div>

                <div id="cards-container"></div>

                <button id="add-more-btn" class="btn-add-more" style="display:none;" onclick="openBatchSelect()">+ Add More Exercises</button>
                
                <button id="list-save-btn" class="btn-sync" style="display:none; background:#007AFF; color:white;" onclick="handleLogAction()">
                    Add to Scorecard
                </button>

                <div id="history-section" class="history-container" style="display:none;">
                    <div class="history-title">Logged on this day</div>
                    <div id="history-list"></div>
                </div>
            </div>
            
            <div id="empty-past-state" style="display:none; text-align:center; padding:40px; color:#aaa;">
                <div style="font-size:40px; margin-bottom:10px;">üí§</div>
                <div style="font-weight:600;">Rest Day</div>
                <div style="font-size:12px;">No workout recorded.</div>
            </div>
        </div>
        
        <div id="nutrition-view" class="hidden-view">
            <div id="nutrition-content-area">
                <div class="habit-card">
                    <div class="habit-header"><span class="habit-title">üíß Water Intake</span><span class="habit-count" id="count-water">0/8</span></div>
                    <div class="habit-bar-bg"><div id="bar-water" class="habit-bar-fill bg-water"></div></div>
                    <div class="circle-row" data-habit="water" data-goal="8"></div>
                </div>
                <div class="habit-card">
                    <div class="habit-header"><span class="habit-title">ü•¶ Veggies</span><span class="habit-count" id="count-veggies">0/5</span></div>
                    <div class="habit-bar-bg"><div id="bar-veggies" class="habit-bar-fill bg-veggie"></div></div>
                    <div class="circle-row" data-habit="veggies" data-goal="5"></div>
                </div>
                <div class="habit-card">
                    <div class="habit-header"><span class="habit-title">üçé Fruits</span><span class="habit-count" id="count-fruits">0/5</span></div>
                    <div class="habit-bar-bg"><div id="bar-fruits" class="habit-bar-fill bg-fruit"></div></div>
                    <div class="circle-row" data-habit="fruits" data-goal="5"></div>
                </div>
                <div class="habit-card">
                    <div class="habit-header"><span class="habit-title">ü•ú Healthy Snacks</span><span class="habit-count" id="count-snacks">0/2</span></div>
                    <div class="habit-bar-bg"><div id="bar-snacks" class="habit-bar-fill bg-snack"></div></div>
                    <div class="circle-row" data-habit="snacks" data-goal="2"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-batch" class="modal-overlay" onclick="closeModal('modal-batch')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Add Workout</div><button class="btn-close" onclick="closeModal('modal-batch')">‚úï</button></div>
            <div class="modal-tabs">
                <div id="tab-browse" class="modal-tab active" onclick="switchModalTab('browse')">Browse List</div>
                <div id="tab-magic" class="modal-tab" onclick="switchModalTab('magic')">‚ú® Workout Generator</div>
            </div>
            <div id="view-browse" style="display:flex; flex-direction:column; height:100%; overflow:hidden;">
                <div class="filter-section-title">üìç Filter by Location</div>
                <div class="filter-scroll">
                    <button id="mloc-home" class="loc-chip active" onclick="setModalLoc('home')">Home / Outdoor</button>
                    <button id="mloc-gym" class="loc-chip" onclick="setModalLoc('gym')">Gym / Studio</button>
                </div>
                <div class="filter-section-title">üí™ Filter by Body Part</div>
                <div class="filter-scroll">
                    <button id="cat-upper" class="cat-chip active" onclick="filterBatch('upper', this)">Upper</button>
                    <button id="cat-lower" class="cat-chip" onclick="filterBatch('lower', this)">Lower</button>
                    <button id="cat-core" class="cat-chip" onclick="filterBatch('core', this)">Core</button>
                    <button id="cat-cardio" class="cat-chip" onclick="filterBatch('cardio', this)">Cardio</button>
                    <button id="cat-studio" class="cat-chip" onclick="filterBatch('studio', this)">Studio</button>
                </div>
                <div id="batch-list" class="select-list"></div>
                <button class="btn-confirm-add" onclick="confirmBatchAdd()">Add Selected</button>
            </div>
            <div id="view-magic" style="display:none; flex-direction:column; height:100%; overflow-y:auto;">
                <div class="gen-section">
                    <div class="gen-label">1. Where are you?</div>
                    <div class="filter-scroll">
                        <button id="gloc-home" class="loc-chip active" onclick="setGenLoc('home')">Home</button>
                        <button id="gloc-gym" class="loc-chip" onclick="setGenLoc('gym')">Gym/Studio</button>
                        <button id="gloc-bodyweight" class="loc-chip" onclick="setGenLoc('bodyweight')">Bodyweight</button>
                    </div>
                </div>
                <div class="gen-section">
                    <div class="gen-label">2. Focus (Select Multiple)</div>
                    <div style="display:flex; flex-wrap:wrap; gap:8px;">
                        <button class="focus-chip" onclick="toggleFocus('upper', this)">Upper</button>
                        <button class="focus-chip" onclick="toggleFocus('lower', this)">Lower</button>
                        <button class="focus-chip" onclick="toggleFocus('core', this)">Core</button>
                        <button class="focus-chip" onclick="toggleFocus('cardio', this)">Cardio</button>
                    </div>
                </div>
                <div class="gen-section">
                    <div class="gen-label">3. Time & Intensity</div>
                    <div class="slider-container">
                        <span>üî•</span>
                        <input type="range" id="gen-intensity" min="1" max="3" step="1">
                        <span class="slider-val" id="val-intensity">2</span>
                    </div>
                </div>
                <button class="btn-confirm-add" style="background: linear-gradient(135deg, #FFD700, #FF9500); box-shadow:0 8px 20px rgba(255,165,0,0.4);" onclick="generateMagicWorkout()">‚ú® Create Workout</button>
            </div>
        </div>
    </div>

    <div id="modal-user" class="modal-overlay" onclick="closeModal('modal-user')">
        <div class="modal-content" style="height:auto !important; max-height:80vh !important;" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Select Team Member</div><button class="btn-close" onclick="closeModal('modal-user')">‚úï</button></div>
            <div style="display:flex; flex-wrap:wrap; gap:10px; padding-bottom:20px;">
                <button class="cat-chip" onclick="selectUser('Mami')">Mami</button>
                <button class="cat-chip" onclick="selectUser('Papi')">Papi</button>
                <button class="cat-chip" onclick="selectUser('Santi')">Santi</button>
                <button class="cat-chip" onclick="selectUser('Fran')">Fran</button>
                <button class="cat-chip" onclick="selectUser('Dana')">Dana</button>
                <button class="cat-chip" onclick="selectUser('Matu')">Matu</button>
                <button class="cat-chip" onclick="selectUser('Caro')">Caro</button>
                <button class="cat-chip" onclick="selectUser('Sofi')">Sofi</button>
                <button class="cat-chip" onclick="selectUser('Andi')">Andi</button>
                <button class="cat-chip" onclick="selectUser('Meredith')">Meredith</button>
                <button class="cat-chip" onclick="selectUser('Ceci')">Ceci</button>
                <button class="cat-chip" id="other-toggle" onclick="document.getElementById('other-input').style.display='block'">+ Other</button>
            </div>
            <input type="text" id="other-input" placeholder="Guest Name..." style="display:none; width:100%; padding:15px; margin-top:15px; border:1px solid #ddd; border-radius:12px;">
            <button class="btn-confirm-add" style="margin-top:20px;" onclick="closeModal('modal-user')">Done</button>
        </div>
    </div>
    
    <div id="modal-barcode" class="modal-overlay" onclick="closeModal('modal-barcode')" style="align-items: flex-start; padding-top: 50px;">
        <div class="modal-content" style="height:auto; border-radius:24px;" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Scan Entry</div><button class="btn-close" onclick="closeModal('modal-barcode')">‚úï</button></div>
            <div style="height:200px; background:black; border-radius:16px; display:flex; align-items:center; justify-content:center; margin-bottom:15px;">
                <span style="color:white; font-weight:600;">[ Camera Feed ]</span>
            </div>
            <p style="text-align:center; color:#888;">Simulated: Barcode detected</p>
            <button class="btn-confirm-add" onclick="alert('Checked In!'); closeModal('modal-barcode')">Confirm Check-in</button>
        </div>
    </div>

    <script>
        // CONFIG & STATE
        const API_URL = "https://script.google.com/macros/s/AKfycbzQpC-1FwLz_iWn7WnBvFhXN7d2YgG3a5pLk8jT9xH4mN2bV6c/exec";
        let currentUser = localStorage.getItem('noguera_user') || null;
        let viewingDateStr = new Date().toISOString().split('T')[0];
        let dailyLog = [];
        let currentStaging = [];
        let isPastMode = false;
        
        // --- NEW VARIABLES FOR LOADING STATE ---
        let isHistoryLoading = true; 
        let cloudHistoryCache = {};

        // EXERCISE DATABASE
        const exerciseList = [
            { name: "Bicep Curls", type: "upper", loc: ["home", "gym"], img: "images/bicep-curls.png", guide: "3 sets ‚Ä¢ 8-12 reps" },
            { name: "Push Ups", type: "upper", loc: ["home", "gym", "bodyweight", "studio"], img: "images/push-ups.png", guide: "3 sets ‚Ä¢ Failure" },
            { name: "Goblet Squat", type: "lower", loc: ["home", "gym"], img: "images/goblet-squat.png", guide: "3 sets ‚Ä¢ 12 reps" },
            { name: "Leg Press", type: "lower", loc: ["gym"], img: "images/leg-press.png", guide: "3 sets ‚Ä¢ 8-12 reps" },
            { name: "Leg Extension", type: "lower", loc: ["gym"], img: "images/leg-extension.png", guide: "3 sets ‚Ä¢ 8-12 reps" },
            { name: "Single Leg Glute Bridge", type: "lower", loc: ["home", "gym", "bodyweight"], img: "images/glute-bridge.png", guide: "3 sets ‚Ä¢ 8-12 reps" },
            { name: "Leg Curl", type: "lower", loc: ["gym"], img: "images/leg-curl.png", guide: "3 sets ‚Ä¢ 8-12 reps" },
            { name: "Bulgarian Split Squat", type: "lower", loc: ["home", "gym", "bodyweight"], img: "images/split-squat.png", guide: "3 sets ‚Ä¢ 8 reps each" },
            { name: "Lat Pulldown", type: "upper", loc: ["gym"], img: "images/lat-pulldown.png", guide: "3 sets ‚Ä¢ 10-12 reps" },
            { name: "Dumbbell Row", type: "upper", loc: ["home", "gym"], img: "images/db-row.png", guide: "3 sets ‚Ä¢ 10 reps" },
            { name: "Shoulder Press", type: "upper", loc: ["home", "gym"], img: "images/shoulder-press.png", guide: "3 sets ‚Ä¢ 8-10 reps" },
            { name: "Lateral Raise", type: "upper", loc: ["home", "gym"], img: "images/lat-raise.png", guide: "3 sets ‚Ä¢ 12-15 reps" },
            { name: "Plank", type: "core", loc: ["home", "gym", "bodyweight", "studio"], img: "images/plank.png", guide: "3 sets ‚Ä¢ 45-60 sec" },
            { name: "Crunches", type: "core", loc: ["home", "gym", "bodyweight", "studio"], img: "images/crunches.png", guide: "3 sets ‚Ä¢ 20 reps" },
            { name: "Russian Twists", type: "core", loc: ["home", "gym", "bodyweight"], img: "images/russian-twist.png", guide: "3 sets ‚Ä¢ 20 reps" },
            { name: "Treadmill Run", type: "cardio", loc: ["gym"], img: "images/treadmill.png", guide: "20-30 mins" },
            { name: "Outdoor Run", type: "cardio", loc: ["home"], img: "images/run.png", guide: "3-5 km" },
            { name: "Elliptical", type: "cardio", loc: ["gym"], img: "images/elliptical.png", guide: "20 mins" },
            { name: "Jump Rope", type: "cardio", loc: ["home", "gym", "studio"], img: "images/jump-rope.png", guide: "10 mins" },
            { name: "Yoga Flow", type: "studio", loc: ["home", "studio", "gym"], img: "images/yoga.png", guide: "30 mins" },
            { name: "Pilates", type: "studio", loc: ["home", "studio", "gym"], img: "images/pilates.png", guide: "45 mins" }
        ];

        /* --- INIT --- */
        window.onload = function() {
            if (currentUser) {
                document.getElementById('header-username').innerText = currentUser;
            } else {
                openUserModal();
            }
            
            // Start Loading
            isHistoryLoading = true;
            renderCalendar(new Date()); 
            
            fetchCloudHistory();
            fetchFamilyData(); 

            // Initialize UI
            selectDate(new Date());
            
            // Carousel Scroll Listener
            const track = document.getElementById('carousel-track');
            track.addEventListener('scroll', () => {
                const index = Math.round(track.scrollLeft / track.offsetWidth);
                document.querySelectorAll('.dot').forEach((d, i) => {
                    if (i === index) d.classList.add('active'); else d.classList.remove('active');
                });
            });
            
            initHabits();
        }

        /* --- CLOUD SYNC & DATA LOADING --- */
        async function fetchCloudHistory() {
            try {
                // START LOADING
                isHistoryLoading = true;
                renderCalendar(new Date(viewingDateStr)); // Render ghosts

                const res = await fetch(API_URL + "?action=history");
                const rawRows = await res.json();
                
                // MIDDLE PART: Keep existing logic
                if (!currentUser) return;
                cloudHistoryCache = {}; 
                
                // Replay history logic
                rawRows.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                rawRows.forEach(row => {
                    if (row.name !== currentUser) return;
                    
                    // Parse date M/D/YYYY -> YYYY-MM-DD
                    const parts = row.date.split('/');
                    if (parts.length < 3) return;
                    const isoDate = `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
                    
                    if(!cloudHistoryCache[isoDate]) {
                        cloudHistoryCache[isoDate] = { 
                            log: [], 
                            habits: { water: {current:0}, veggies: {current:0}, fruits: {current:0}, snacks: {current:0} } 
                        };
                    }
                    
                    // Populate Cache
                    if (row.type === 'Workout') {
                         cloudHistoryCache[isoDate].log.push(row);
                    } else if (row.type === 'Habit') {
                         try {
                             const hData = JSON.parse(row.meta); 
                             cloudHistoryCache[isoDate].habits = {
                                 water: {current: hData.water||0},
                                 veggies: {current: hData.veggies||0},
                                 fruits: {current: hData.fruits||0},
                                 snacks: {current: hData.snacks||0}
                             };
                         } catch(e){}
                    }
                });
                
                // END LOADING
                isHistoryLoading = false;
                console.log("History Loaded:", cloudHistoryCache);
                
                renderCalendar(new Date(viewingDateStr)); // Show real dots
                loadDataForDate(viewingDateStr);

            } catch (e) {
                console.error("Failed to fetch cloud history", e);
                isHistoryLoading = false;
                renderCalendar(new Date(viewingDateStr));
            }
        }

        async function fetchFamilyData() {
            try {
                const res = await fetch(API_URL + "?action=history"); // Or action=leaderboard if backend supports it
                const rawRows = await res.json();
                
                let stats = {};
                // Simple aggregation
                rawRows.forEach(r => {
                    if(!stats[r.name]) stats[r.name] = 0;
                    if(r.type === 'Workout') stats[r.name]++; // Count workouts/days
                });
                
                const sorted = Object.entries(stats).sort((a,b) => b[1] - a[1]);
                const lb = document.getElementById('lb-container');
                lb.innerHTML = '';
                
                sorted.forEach((item, idx) => {
                    const rank = idx + 1;
                    let rankClass = 'rank-low';
                    if(rank===1) rankClass = 'rank-1';
                    if(rank===2) rankClass = 'rank-2';
                    if(rank===3) rankClass = 'rank-3';
                    
                    lb.innerHTML += `
                    <div class="lb-row">
                        <div style="display:flex; align-items:center;">
                            <div class="lb-rank ${rankClass}">${rank}</div>
                            <div class="lb-details">
                                <span class="lb-name">${item[0]}</span>
                                <span class="lb-sub">Member</span>
                            </div>
                        </div>
                        <div class="lb-stat-box">
                            <div class="lb-val-main">${item[1]}</div>
                            <div class="lb-val-sub">Days</div>
                        </div>
                    </div>`;
                });
            } catch(e) {
                console.log("Leaderboard error", e);
            }
        }

        /* --- DATE LOGIC --- */
        // REPLACED Render Function
        function renderCalendar(centerDate) {
            const strip = document.getElementById('calendar-strip');
            const monthTitle = document.getElementById('header-month-title');
            strip.innerHTML = '';
            
            const options = { month: 'long', year: 'numeric' };
            monthTitle.innerText = centerDate.toLocaleDateString('en-US', options);

            for (let i = -14; i <= 7; i++) {
                const d = new Date(); 
                d.setDate(d.getDate() + i);
                
                const dateStr = d.toISOString().split('T')[0];
                const isSelected = dateStr === viewingDateStr;
                const isFuture = d > new Date();
                
                // CHECK: Do we have data?
                const hasData = cloudHistoryCache[dateStr] && 
                               (cloudHistoryCache[dateStr].log.length > 0 || cloudHistoryCache[dateStr].habits.water.current > 0);

                const el = document.createElement('div');
                el.className = `cal-day ${isSelected ? 'active' : ''} ${isFuture ? 'future' : ''} ${hasData ? 'has-data' : ''}`;
                el.id = `day-${dateStr}`;
                el.onclick = () => { if(!isFuture) selectDate(d); };
                
                // LOGIC: If loading, show ghost dot. If loaded and has data, show green dot.
                let dotHtml = '';
                if (isHistoryLoading && !isFuture) {
                     dotHtml = '<div class="cal-skeleton-dot"></div>'; // Ghost Dot
                } else {
                     dotHtml = '<div class="cal-dot"></div>'; // Real Dot
                }

                el.innerHTML = `
                    <span class="day-name">${d.toLocaleDateString('en-US', {weekday: 'short'})}</span>
                    <span class="day-num">${d.getDate()}</span>
                    ${dotHtml}
                `;
                strip.appendChild(el);
            }
            
            if(!isHistoryLoading) {
                setTimeout(() => {
                    const activeEl = document.querySelector('.cal-day.active');
                    if(activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                }, 100);
            }
        }

        function selectDate(date) {
            viewingDateStr = date.toISOString().split('T')[0];
            const isToday = new Date().toDateString() === date.toDateString();
            isPastMode = !isToday;
            
            renderCalendar(date);
            updateUIForTimeTravel(date);
            loadDataForDate(viewingDateStr);
        }

        function loadDataForDate(dateStr) {
            // 1. Reset
            currentStaging = [];
            dailyLog = [];
            renderLog();
            ['water','veggies','fruits','snacks'].forEach(h => updateHabitUI(h, 0));

            // 2. Load from Cache if exists
            if(cloudHistoryCache[dateStr]) {
                const data = cloudHistoryCache[dateStr];
                
                // Load Habits
                for(let k in data.habits) {
                    updateHabitUI(k, data.habits[k].current);
                }
                
                // Load Workouts (Display in History or Staging)
                data.log.forEach(item => {
                    dailyLog.push(item);
                });
                renderHistory();
            }
            
            updateScorecardStatus();
        }
        
        function updateUIForTimeTravel(date) {
            const dateBadge = document.getElementById('score-card-date-badge');
            const banner = document.getElementById('past-view-banner');
            const mainBtn = document.getElementById('main-action-btn');
            const editBtn = document.getElementById('edit-past-btn');
            const workContent = document.getElementById('workout-content-area');
            const emptyState = document.getElementById('empty-past-state');
            const nutContent = document.getElementById('nutrition-content-area');
            
            if (isPastMode) {
                dateBadge.innerText = date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
                dateBadge.style.background = '#FF9500'; dateBadge.style.color = 'white';
                banner.style.display = 'block';
                banner.innerText = `üìÖ Viewing Record: ${date.toLocaleDateString()}`;
                
                mainBtn.style.display = 'none';
                editBtn.style.display = 'block';
                
                workContent.classList.add('read-only-mask');
                nutContent.classList.add('read-only-mask');
                
                if (dailyLog.length === 0) {
                    workContent.style.display = 'none';
                    emptyState.style.display = 'block';
                } else {
                    workContent.style.display = 'block';
                    emptyState.style.display = 'none';
                }
            } else {
                dateBadge.innerText = "Today";
                dateBadge.style.background = 'rgba(0,122,255,0.1)'; dateBadge.style.color = 'var(--ios-blue)';
                banner.style.display = 'none';
                mainBtn.style.display = 'block';
                editBtn.style.display = 'none';
                workContent.classList.remove('read-only-mask');
                nutContent.classList.remove('read-only-mask');
                workContent.style.display = 'block';
                emptyState.style.display = 'none';
            }
        }
        
        function enablePastEdit() {
            if(!confirm("Editing past records sends updates to the cloud. Continue?")) return;
            document.getElementById('workout-content-area').classList.remove('read-only-mask');
            document.getElementById('nutrition-content-area').classList.remove('read-only-mask');
            document.getElementById('past-view-banner').style.background = "#34C759";
            document.getElementById('past-view-banner').innerText = "‚úèÔ∏è Editing Enabled";
        }

        /* --- ADD WORKOUT FLOW --- */
        let modalLoc = 'home';
        function openBatchSelect() { document.getElementById('modal-batch').style.display = 'flex'; renderBatchList(); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function switchModalTab(tab) {
            document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            if(tab === 'browse') {
                document.getElementById('view-browse').style.display = 'flex';
                document.getElementById('view-magic').style.display = 'none';
            } else {
                document.getElementById('view-browse').style.display = 'none';
                document.getElementById('view-magic').style.display = 'flex';
            }
        }
        function setModalLoc(loc) {
            modalLoc = loc;
            document.querySelectorAll('#view-browse .loc-chip').forEach(b => b.classList.remove('active'));
            document.getElementById('mloc-'+loc).classList.add('active');
            renderBatchList();
        }
        
        let selectedBatch = [];
        
        function renderBatchList(filterType = null) {
            const container = document.getElementById('batch-list');
            container.innerHTML = '';
            
            const filtered = exerciseList.filter(ex => {
                const locMatch = ex.loc.includes(modalLoc);
                const typeMatch = filterType ? ex.type === filterType : true;
                return locMatch && typeMatch;
            });
            
            filtered.forEach(ex => {
                const isSel = selectedBatch.includes(ex.name);
                const div = document.createElement('div');
                div.className = `select-item ${isSel ? 'selected' : ''}`;
                div.onclick = () => toggleBatchItem(ex.name, div);
                div.innerHTML = `
                    <div class="select-left">
                        <div class="select-check">‚úì</div>
                        <div>
                            <div class="select-name">${ex.name}</div>
                            <div style="font-size:12px; color:#888;">${ex.guide}</div>
                        </div>
                    </div>
                    <img src="${ex.img}" class="select-img">
                `;
                container.appendChild(div);
            });
        }
        
        function toggleBatchItem(name, el) {
            if(selectedBatch.includes(name)) {
                selectedBatch = selectedBatch.filter(n => n !== name);
                el.classList.remove('selected');
            } else {
                selectedBatch.push(name);
                el.classList.add('selected');
            }
        }
        
        function filterBatch(type, btn) {
            document.querySelectorAll('#view-browse .cat-chip').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderBatchList(type);
        }
        
        function confirmBatchAdd() {
            selectedBatch.forEach(name => {
                const ex = exerciseList.find(e => e.name === name);
                if(ex) currentStaging.push(ex);
            });
            selectedBatch = [];
            closeModal('modal-batch');
            renderLog();
        }
        
        /* --- MAGIC GENERATOR --- */
        let genLoc = 'home';
        let genFocus = [];
        function setGenLoc(l) { 
            genLoc = l;
            document.querySelectorAll('#view-magic .loc-chip').forEach(b => b.classList.remove('active'));
            document.getElementById('gloc-'+l).classList.add('active');
        }
        function toggleFocus(f, btn) {
            if(genFocus.includes(f)) {
                genFocus = genFocus.filter(x => x !== f);
                btn.classList.remove('active');
            } else {
                genFocus.push(f);
                btn.classList.add('active');
            }
        }
        function generateMagicWorkout() {
            // Simple Logic: Pick 4-5 exercises matching criteria
            const pool = exerciseList.filter(ex => ex.loc.includes(genLoc) && (genFocus.length === 0 || genFocus.includes(ex.type)));
            if(pool.length === 0) return alert("No matching exercises found!");
            
            const count = 4;
            for(let i=0; i<count; i++) {
                const random = pool[Math.floor(Math.random() * pool.length)];
                currentStaging.push(random);
            }
            closeModal('modal-batch');
            renderLog();
            confetti({ particleCount: 150, spread: 60 });
        }

        /* --- LOGGING & HISTORY --- */
        function renderLog() {
            const container = document.getElementById('cards-container');
            const trigger = document.getElementById('add-trigger-area');
            const addMore = document.getElementById('add-more-btn');
            const listSaveBtn = document.getElementById('list-save-btn');
            
            container.innerHTML = '';
            
            if (currentStaging.length === 0) {
                trigger.style.display = 'flex';
                addMore.style.display = 'none';
                listSaveBtn.style.display = 'none';
            } else {
                trigger.style.display = 'none';
                addMore.style.display = 'block';
                listSaveBtn.style.display = 'flex';
                listSaveBtn.innerText = `Add ${currentStaging.length} to Scorecard`;
                
                currentStaging.forEach((item, idx) => {
                    const card = document.createElement('div');
                    card.className = 'exercise-card';
                    card.innerHTML = `
                        <button class="btn-remove-card" onclick="removeStaged(${idx})">√ó</button>
                        <img src="${item.img}" class="exercise-img">
                        <div class="exercise-details">
                            <div class="exercise-name">${item.name}</div>
                            <div class="exercise-instruction">${item.guide}</div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
        }
        
        function removeStaged(idx) {
            currentStaging.splice(idx, 1);
            renderLog();
        }
        
        async function handleLogAction() {
            if(!currentUser) return alert("Select User First");
            
            // Post each to sheet
            const promises = currentStaging.map(ex => {
                const payload = {
                    action: 'log',
                    user: currentUser,
                    date: viewingDateStr,
                    type: 'Workout',
                    val: 1, // Count as 1 exercise
                    meta: ex.name
                };
                return fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            });
            
            await Promise.all(promises);
            
            // Move to history
            currentStaging.forEach(ex => dailyLog.push({name: ex.name, guide: ex.guide}));
            currentStaging = [];
            
            renderLog();
            renderHistory();
            fetchCloudHistory(); // Refresh dots
            confetti();
        }
        
        function renderHistory() {
            const list = document.getElementById('history-list');
            const sec = document.getElementById('history-section');
            list.innerHTML = '';
            
            if(dailyLog.length === 0) {
                sec.style.display = 'none';
                return;
            }
            sec.style.display = 'block';
            
            dailyLog.forEach(item => {
                // Check if item is an object (local) or row (cloud)
                // Cloud row: [date, name, type, val, meta]
                const name = item.meta || item.name; 
                
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `<span>‚úÖ ${name}</span>`;
                list.appendChild(div);
            });
            updateScorecardStatus();
        }

        /* --- HABITS --- */
        function initHabits() {
            document.querySelectorAll('.circle-row').forEach(row => {
                const h = row.dataset.habit;
                const g = parseInt(row.dataset.goal);
                for(let i=1; i<=g; i++) {
                    const d = document.createElement('div');
                    d.className = `habit-circle`;
                    if(h==='water') d.classList.add('bg-water');
                    if(h==='veggies') d.classList.add('bg-veggie');
                    if(h==='fruits') d.classList.add('bg-fruit');
                    if(h==='snacks') d.classList.add('bg-snack');
                    
                    d.onclick = () => toggleHabit(h, i);
                    row.appendChild(d);
                }
            });
        }
        
        function toggleHabit(habit, val) {
            if(isPastMode && !confirm("Update past habit?")) return;
            updateHabitUI(habit, val);
            
            // Save Full Habit State
            const habits = {
                water: getHabitVal('water'),
                veggies: getHabitVal('veggies'),
                fruits: getHabitVal('fruits'),
                snacks: getHabitVal('snacks')
            };
            
            const payload = {
                action: 'log',
                user: currentUser,
                date: viewingDateStr,
                type: 'Habit',
                val: 0,
                meta: JSON.stringify(habits)
            };
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });
            // Optimistic update (cloud fetch will confirm later)
            if(!cloudHistoryCache[viewingDateStr]) cloudHistoryCache[viewingDateStr] = {log:[], habits:{water:{current:0}, veggies:{current:0}, fruits:{current:0}, snacks:{current:0}}};
            cloudHistoryCache[viewingDateStr].habits[habit].current = val;
            renderCalendar(new Date(viewingDateStr));
        }
        
        function updateHabitUI(h, val) {
            const row = document.querySelector(`.circle-row[data-habit="${h}"]`);
            if(!row) return;
            const g = row.children.length;
            
            Array.from(row.children).forEach((c, i) => {
                if(i < val) c.classList.add('active');
                else c.classList.remove('active');
            });
            
            document.getElementById(`count-${h}`).innerText = `${val}/${g}`;
            document.getElementById(`bar-${h}`).style.width = `${(val/g)*100}%`;
            
            // Update Scorecard View
            document.getElementById(`score-${h}`).innerText = `${val} / ${g}`;
        }
        
        function getHabitVal(h) {
            return parseInt(document.getElementById(`count-${h}`).innerText.split('/')[0]);
        }

        function updateScorecardStatus() {
            document.getElementById('score-workout').innerText = `${dailyLog.length} Done`;
            if(dailyLog.length > 0) document.getElementById('score-workout').classList.add('done');
            else document.getElementById('score-workout').classList.remove('done');
        }

        /* --- NAVIGATION --- */
        function switchTab(t) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-'+t).classList.add('active');
            if(t === 'workout') {
                document.getElementById('workout-view').classList.remove('hidden-view');
                document.getElementById('nutrition-view').classList.add('hidden-view');
            } else {
                document.getElementById('workout-view').classList.add('hidden-view');
                document.getElementById('nutrition-view').classList.remove('hidden-view');
            }
        }
        
        function selectUser(name) {
            currentUser = name;
            localStorage.setItem('noguera_user', name);
            document.getElementById('header-username').innerText = name;
            
            const otherInp = document.getElementById('other-input');
            if(otherInp.style.display === 'block' && otherInp.value) {
                currentUser = otherInp.value;
                document.getElementById('header-username').innerText = currentUser;
            }
            
            closeModal('modal-user');
            fetchCloudHistory();
        }

        function openBarcode() { document.getElementById('modal-barcode').style.display = 'flex'; }
        function openUserModal() { document.getElementById('modal-user').style.display = 'flex'; }
        function shareScorecard() { alert("Screenshot this screen to share!"); }
    </script>
</body>
</html>
