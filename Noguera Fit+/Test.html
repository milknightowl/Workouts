<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NogueraFit</title>
    
    <link rel="apple-touch-icon" href="images/icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- iOS DESIGN SYSTEM --- */
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-gray: #F2F2F7;
            --ios-red: #FF3B30;
            --text-dark: #1C1C1E;
            --text-light: #8E8E93;
            --bg-off-white: #F9F9F9;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #F2F2F7;
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
        }

        .app-content {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 120px;
        }

        /* --- HEADER --- */
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        
        .user-select-btn {
            background: none; border: none; font-size: 17px; font-weight: 700; color: var(--ios-blue);
            display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 0;
        }

        .btn-barcode { 
            background: #E5E5EA; border: none; padding: 6px 12px; border-radius: 14px; 
            font-size: 12px; font-weight: 700; color: #555; cursor: pointer; 
        }

        /* --- PROGRESS SECTION (Moved Up) --- */
        .progress-wrapper { background: white; padding: 15px; border-radius: 18px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .progress-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: var(--text-light); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .progress-container { width: 100%; background-color: #E5E5EA; border-radius: 6px; height: 10px; overflow: hidden; margin-bottom: 12px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--ios-blue), #5AC8FA); width: 1%; transition: width 0.5s ease; border-radius: 6px; }
        
        .day-controls { display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 600; }
        .day-select { font-size: 16px; font-weight: 800; color: var(--text-dark); border: none; background: #F2F2F7; padding: 4px 10px; border-radius: 8px; margin: 0 8px; text-align: center; }

        /* --- SCORECARD --- */
        .scorecard-container {
            background: white; border-radius: 24px; padding: 20px; margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.06); position: relative; overflow: hidden;
        }
        .scorecard-container::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 5px; background-color: #007AFF; }
        .scorecard-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; }
        .scorecard-title { font-size: 22px; font-weight: 800; color: #1C1C1E; }
        .scorecard-date { font-size: 12px; color: var(--ios-blue); font-weight: 700; text-transform: uppercase; background: rgba(0,122,255,0.1); padding: 4px 10px; border-radius: 20px; }

        .score-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 6px 0; border-bottom: 1px dashed #F2F2F7; font-size: 15px; }
        .score-row:last-of-type { border-bottom: none; }
        .score-label { font-weight: 600; color: #666; }
        .score-val { font-weight: 700; color: #1C1C1E; }
        .score-val.done { color: var(--ios-green); }

        .btn-sync { 
            width: 100%; padding: 14px; border-radius: 14px; font-size: 15px; font-weight: 700; 
            border: none; cursor: pointer; margin-top: 15px; transition: 0.2s;
            background-color: var(--text-dark); color: white; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-sync.synced { background-color: var(--ios-green); pointer-events: auto; } /* Turns green but stays clickable for share */

        /* --- TABS --- */
        .tab-bar { display: flex; background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); padding: 5px; gap: 5px; position: sticky; top: 10px; z-index: 90; margin-bottom: 20px; border-radius: 14px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; padding: 10px; border-radius: 10px; text-align: center; font-weight: 700; font-size: 13px; cursor: pointer; color: var(--text-light); transition: all 0.2s; }
        .tab-btn.active { background: white; color: var(--text-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #tab-workout.active { color: var(--ios-blue); }
        #tab-nutrition.active { color: var(--ios-green); }

        /* --- WORKOUT LOGGER --- */
        /* Combined Empty/Add State */
        .big-add-btn {
            background: white; border: 2px dashed #D1D1D6; border-radius: 20px; padding: 30px;
            text-align: center; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 10px;
            color: #8E8E93; width: 100%; margin-bottom: 20px;
        }
        .big-add-btn:active { background: #F2F2F7; border-color: var(--ios-blue); color: var(--ios-blue); }
        .big-icon { font-size: 32px; display: block; margin-bottom: 5px; }

        /* Log List */
        .log-list { list-style: none; padding: 0; margin: 0 0 20px 0; }
        .log-item { background: white; padding: 14px 18px; border-radius: 14px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.02); animation: slideIn 0.2s ease-out; }
        .log-item-name { font-weight: 600; font-size: 15px; }
        .log-item-meta { font-size: 12px; color: #888; margin-top: 2px; }
        .btn-delete { color: #FF3B30; background: none; border: none; font-size: 18px; padding: 5px; cursor: pointer; }

        .btn-add-more { 
            background: white; color: var(--ios-blue); border: 1px solid var(--ios-blue); width: 100%; padding: 12px; 
            border-radius: 14px; font-weight: 700; margin-bottom: 30px; cursor: pointer;
        }

        /* --- HABITS --- */
        .hidden-view { display: none !important; }
        .habit-card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .habit-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
        .habit-title { font-weight: 700; font-size: 16px; }
        .habit-count { font-size: 14px; font-weight: 600; color: #888; background: #f2f2f7; padding: 3px 8px; border-radius: 6px; }
        .habit-bar-bg { height: 8px; background: #F2F2F7; border-radius: 4px; overflow: hidden; margin-bottom: 12px; }
        .habit-bar-fill { height: 100%; width: 0%; border-radius: 4px; transition: 0.3s; }
        .circle-row { display: flex; gap: 8px; }
        .habit-circle { width: 26px; height: 26px; border-radius: 50%; border: 2px solid #E5E5EA; cursor: pointer; transition: 0.2s; }
        .habit-circle.active { transform: scale(1.1); border-color: transparent; }
        
        /* Colors */
        .bg-water { background: #5AC8FA; } .bg-veggie { background: #34C759; } .bg-fruit { background: #FF3B30; } .bg-snack { background: #AF52DE; }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-content { background: #F2F2F7; width: 100%; max-width: 600px; border-radius: 20px 20px 0 0; padding: 20px; max-height: 85vh; overflow-y: auto; box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: 800; }
        .btn-close { background: #E5E5EA; border: none; width: 28px; height: 28px; border-radius: 50%; color: #555; font-weight: bold; cursor: pointer; }

        /* Batch Select UI */
        .cat-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 15px; }
        .cat-chip { padding: 8px 16px; background: white; border-radius: 20px; font-weight: 600; font-size: 14px; white-space: nowrap; color: #888; cursor: pointer; border: 1px solid transparent; }
        .cat-chip.active { background: var(--ios-blue); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }

        .select-list { display: flex; flex-direction: column; gap: 8px; max-height: 400px; overflow-y: auto; }
        .select-item { background: white; padding: 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.1s; }
        .select-item.selected { background: #E3F2FD; border: 1px solid var(--ios-blue); }
        .select-check { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #D1D1D6; display: flex; align-items: center; justify-content: center; color: transparent; }
        .select-item.selected .select-check { background: var(--ios-blue); border-color: var(--ios-blue); color: white; font-size: 14px; }

        .btn-confirm-add { width: 100%; padding: 16px; background: var(--ios-blue); color: white; font-weight: 700; border-radius: 16px; border: none; margin-top: 15px; cursor: pointer; font-size: 16px; }

        /* Leaderboard Overhaul */
        .lb-row { display: flex; align-items: center; justify-content: space-between; padding: 14px 10px; border-bottom: 1px solid #E5E5EA; background: white; }
        .lb-row:nth-child(even) { background: #FAFAFC; }
        .lb-rank { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: 800; border-radius: 50%; margin-right: 12px; font-size: 14px; }
        .rank-1 { background: #FFD700; color: #B48902; } /* Gold */
        .rank-2 { background: #C0C0C0; color: #555; } /* Silver */
        .rank-3 { background: #CD7F32; color: #6A3906; } /* Bronze */
        .rank-low { background: #F2F2F7; color: #8E8E93; font-size: 12px; }
        
        .lb-details { flex: 1; }
        .lb-name { font-weight: 700; font-size: 15px; color: #1C1C1E; }
        .lb-status { font-size: 13px; font-weight: 600; text-align: right; }
        .status-done { color: var(--ios-green); }
        .status-pending { color: #C7C7CC; font-weight: 500; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    </style>
</head>
<body>

    <div class="app-content">
        <div class="top-nav">
            <button class="user-select-btn" onclick="openUserModal()">
                <span id="header-username">üë• Select Team</span> <span>‚ñº</span>
            </button>
            <button class="btn-barcode" onclick="openBarcode()">Gym Pass</button>
        </div>

        <div class="progress-wrapper">
            <div class="progress-header"><span>Challenge Progress</span><span id="progress-text">0%</span></div>
            <div class="progress-container"><div id="visual-progress" class="progress-fill"></div></div>
            <div class="day-controls">
                Day <select id="dayInput" class="day-select" onchange="updateProgressUI()"></select> of 100
            </div>
        </div>

        <div class="scorecard-container">
            <div class="scorecard-header">
                <div class="scorecard-title">Scorecard</div>
                <div class="scorecard-date" id="today-date">Today</div>
            </div>
            <div class="score-row">
                <span class="score-label">üèãÔ∏è Exercise</span>
                <span class="score-val" id="score-workout">0 Activities</span>
            </div>
            <div class="score-row">
                <span class="score-label">üíß Nutrition</span>
                <span class="score-val" id="score-nutrition">Incomplete</span>
            </div>
            
            <button id="main-action-btn" class="btn-sync" onclick="handleMainAction()">
                ‚òÅÔ∏è Sync to Cloud
            </button>
            <button class="btn-sync" style="background:#FFF8E1; color:#FF9500; margin-top:8px;" onclick="openLeaderboard()">
                üèÜ Leaderboard
            </button>
        </div>

        <div class="tab-bar">
            <div id="tab-workout" class="tab-btn active" onclick="switchTab('workout')">EXERCISE</div>
            <div id="tab-nutrition" class="tab-btn" onclick="switchTab('nutrition')">NUTRITION</div>
        </div>

        <div id="workout-view">
            <div id="add-trigger-area" class="big-add-btn" onclick="openBatchSelect()">
                <span class="big-icon">‚ûï</span>
                <span style="font-weight:700; font-size:16px; color:#333;">Start Workout</span>
                <span style="font-size:13px;">Tap to select exercises</span>
            </div>

            <ul id="log-list" class="log-list"></ul>

            <button id="add-more-btn" class="btn-add-more" style="display:none;" onclick="openBatchSelect()">+ Add More Exercises</button>
        </div>
        
        <div id="nutrition-view" class="hidden-view">
            <div class="habit-card">
                <div class="habit-header"><span class="habit-title">üíß Water Intake</span><span class="habit-count" id="count-water">0/8</span></div>
                <div class="habit-bar-bg"><div id="bar-water" class="habit-bar-fill bg-water"></div></div>
                <div class="circle-row" data-habit="water" data-goal="8"></div>
            </div>
            <div class="habit-card">
                <div class="habit-header"><span class="habit-title">ü•¶ Veggies</span><span class="habit-count" id="count-veggies">0/5</span></div>
                <div class="habit-bar-bg"><div id="bar-veggies" class="habit-bar-fill bg-veggie"></div></div>
                <div class="circle-row" data-habit="veggies" data-goal="5"></div>
            </div>
            <div class="habit-card">
                <div class="habit-header"><span class="habit-title">üçé Fruits</span><span class="habit-count" id="count-fruits">0/5</span></div>
                <div class="habit-bar-bg"><div id="bar-fruits" class="habit-bar-fill bg-fruit"></div></div>
                <div class="circle-row" data-habit="fruits" data-goal="5"></div>
            </div>
            <div class="habit-card">
                <div class="habit-header"><span class="habit-title">ü•ú Healthy Snacks</span><span class="habit-count" id="count-snacks">0/2</span></div>
                <div class="habit-bar-bg"><div id="bar-snacks" class="habit-bar-fill bg-snack"></div></div>
                <div class="circle-row" data-habit="snacks" data-goal="2"></div>
            </div>
        </div>
    </div>

    <div id="modal-batch" class="modal-overlay" onclick="closeModal('modal-batch')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Build Routine</div>
                <button class="btn-close" onclick="closeModal('modal-batch')">‚úï</button>
            </div>
            
            <div class="cat-list">
                <div class="cat-chip active" onclick="filterBatch('upper', this)">Upper</div>
                <div class="cat-chip" onclick="filterBatch('lower', this)">Lower</div>
                <div class="cat-chip" onclick="filterBatch('core', this)">Core</div>
                <div class="cat-chip" onclick="filterBatch('cardio', this)">Cardio</div>
                <div class="cat-chip" onclick="filterBatch('studio', this)">Studio</div>
            </div>

            <div id="batch-list" class="select-list"></div>
            
            <button class="btn-confirm-add" onclick="confirmBatchAdd()">Add Exercises</button>
        </div>
    </div>

    <div id="modal-user" class="modal-overlay" onclick="closeModal('modal-user')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Select Team</div><button class="btn-close" onclick="closeModal('modal-user')">‚úï</button></div>
            <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:10px;">
                <button class="cat-chip" onclick="selectUser('Mami')">Mami</button>
                <button class="cat-chip" onclick="selectUser('Papi')">Papi</button>
                <button class="cat-chip" onclick="selectUser('Santi')">Santi</button>
                <button class="cat-chip" onclick="selectUser('Fran')">Fran</button>
                <button class="cat-chip" onclick="selectUser('Dana')">Dana</button>
                <button class="cat-chip" onclick="selectUser('Matu')">Matu</button>
                <button class="cat-chip" onclick="selectUser('Caro')">Caro</button>
                <button class="cat-chip" onclick="selectUser('Sofi')">Sofi</button>
                <button class="cat-chip" onclick="selectUser('Andi')">Andi</button>
                <button class="cat-chip" onclick="selectUser('Meredith')">Meredith</button>
                <button class="cat-chip" onclick="selectUser('Ceci')">Ceci</button>
                <button class="cat-chip" id="other-toggle" onclick="document.getElementById('other-input').style.display='block'">+ Other</button>
            </div>
            <input type="text" id="other-input" placeholder="Guest Name..." style="display:none; width:100%; padding:15px; margin-top:15px; border:1px solid #ddd; border-radius:12px;">
            <button class="btn-confirm-add" style="margin-top:20px;" onclick="closeModal('modal-user')">Done</button>
        </div>
    </div>

    <div id="modal-barcode" class="modal-overlay" onclick="closeModal('modal-barcode')">
        <div class="modal-content" style="text-align:center;" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Gym Pass</div><button class="btn-close" onclick="closeModal('modal-barcode')">‚úï</button></div>
            <h3 style="margin:0 0 10px 0;">Bretton Woods</h3>
            <img src="images/barcode.jpg" alt="Barcode" style="width:100%; border-radius:8px;">
        </div>
    </div>

    <div id="leaderboard-modal" class="modal-overlay">
        <div class="modal-content" style="padding:0; overflow:hidden; max-height:80vh; display:flex; flex-direction:column;">
            <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-size:20px; font-weight:800;">Standings</div>
                <button class="btn-close" onclick="document.getElementById('leaderboard-modal').style.display='none'">‚úï</button>
            </div>
            <div style="padding:10px; background:#F2F2F7; display:flex; gap:10px;">
                <div class="tab-btn active" id="lb-tab-day" onclick="renderLeaderboard('today')" style="background:white; color:black;">Today</div>
                <div class="tab-btn" id="lb-tab-streak" onclick="renderLeaderboard('streak')">Streak</div>
            </div>
            <div id="lb-content" style="overflow-y:auto; flex:1;"></div>
        </div>
    </div>

<audio id="success-sound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwZ6Es95wHMe2C4-SFDraVwkyEy2lpchaY4zXmdCt15FTCBJsGWp3emGfTqoe5soeze/exec"; 

    // --- STATE ---
    let currentUser = null; 
    let currentLog = [];
    let selectedBatch = new Set();
    let isSynced = false;
    let familyData = []; 

    let habitsData = {
        water: { current: 0, goal: 8 },
        veggies: { current: 0, goal: 5 }, 
        fruits: { current: 0, goal: 5 },
        snacks: { current: 0, goal: 2 }
    };

    const exerciseDB = [
        { name: "Dumbbell Shoulder Press", type: "upper" }, { name: "Incline Dumbbell Press", type: "upper" },
        { name: "Cable Tricep Pushdown", type: "upper" }, { name: "Lat Pulldown", type: "upper" },
        { name: "Seated Cable Row", type: "upper" }, { name: "Dumbbell Row", type: "upper" },
        { name: "Bicep Curls", type: "upper" }, { name: "Push Ups", type: "upper" },
        { name: "Goblet Squat", type: "lower" }, { name: "Leg Press", type: "lower" },
        { name: "Leg Extension", type: "lower" }, { name: "Leg Curl", type: "lower" },
        { name: "Bulgarian Split Squat", type: "lower" }, { name: "Air Squats", type: "lower" },
        { name: "Plank", type: "core" }, { name: "Crunches", type: "core" },
        { name: "Running", type: "cardio" }, { name: "Swimming", type: "cardio" },
        { name: "Elliptical", type: "cardio" }, { name: "Stairmaster", type: "cardio" },
        { name: "Hot Yoga", type: "studio" }, { name: "Reformer Pilates", type: "studio" },
        { name: "Mat Pilates", type: "studio" }
    ];

    window.onload = function() {
        document.getElementById('today-date').innerText = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        // Days 1-100
        const select = document.getElementById('dayInput');
        for (let i = 1; i <= 100; i++) {
            let opt = document.createElement('option'); opt.value = i; opt.innerHTML = i; select.appendChild(opt);
        }

        loadState();
        updateProgressUI();
        initHabits();
        renderLog();
    }

    // --- MAIN ACTIONS ---
    function handleMainAction() {
        if (!isSynced) {
            syncToCloud();
        } else {
            shareScorecard();
        }
    }

    function syncToCloud() {
        if (!currentUser && !document.getElementById('other-input').value) {
            alert("‚ö†Ô∏è Please select who you are at the top!");
            openUserModal();
            return;
        }

        const btn = document.getElementById('main-action-btn');
        btn.innerHTML = "‚è≥ Syncing...";
        
        // Determine User Name
        const finalName = currentUser || document.getElementById('other-input').value;

        // Compile Data
        const habitStr = `W:${habitsData.water.current}, V:${habitsData.veggies.current}, F:${habitsData.fruits.current}, S:${habitsData.snacks.current}`;
        const workoutStr = currentLog.length > 0 ? currentLog.map(i => i.name).join(", ") : "Rest Day";
        
        const payload = {
            date: new Date().toLocaleString(),
            day: document.getElementById('dayInput').value,
            name: finalName,
            location: "Log",
            workout: workoutStr + " | " + habitStr
        };

        fetch(API_URL, {
            method: 'POST', mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            isSynced = true;
            document.getElementById('success-sound').play().catch(()=>{});
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            
            // Transform Button
            btn.innerHTML = "üì§ Share Scorecard";
            btn.classList.add('synced');
            
            // Save local marker
            localStorage.setItem('nogueraFit_synced', 'true');
        }).catch(err => {
            alert("Error syncing. Check internet.");
            btn.innerHTML = "‚òÅÔ∏è Retry Sync";
        });
    }

    function shareScorecard() {
        const day = document.getElementById('dayInput').value;
        let text = `üî• NogueraFit Day ${day}\n`;
        
        if (currentLog.length > 0) {
            text += `‚úÖ WORKOUT:\n`;
            currentLog.forEach(i => text += `‚Ä¢ ${i.name}\n`);
        } else {
            text += `üí§ Rest Day\n`;
        }

        text += `\nü•ó NUTRITION:\n`;
        text += `üíß Water: ${habitsData.water.current}/8\n`;
        text += `ü•¶ Veggies: ${habitsData.veggies.current}/5\n`;
        text += `üçé Fruits: ${habitsData.fruits.current}/5\n`;
        text += `ü•ú Snacks: ${habitsData.snacks.current}/2`;

        if (navigator.share) navigator.share({ title: 'NogueraFit', text: text });
        else {
            navigator.clipboard.writeText(text);
            alert("Copied to clipboard!");
        }
    }

    // --- LOGGING LOGIC ---
    function openBatchSelect() {
        document.getElementById('modal-batch').style.display = 'flex';
        selectedBatch.clear();
        filterBatch('upper', document.querySelector('.cat-chip')); // Default to upper
    }

    function filterBatch(type, btnEl) {
        // UI
        document.querySelectorAll('.cat-chip').forEach(c => c.classList.remove('active'));
        btnEl.classList.add('active');

        // Render List
        const container = document.getElementById('batch-list');
        container.innerHTML = '';
        const list = exerciseDB.filter(ex => ex.type === type);
        
        list.forEach(ex => {
            const div = document.createElement('div');
            div.className = 'select-item';
            // Check if already in batch OR already in log
            const isSelected = selectedBatch.has(ex.name);
            if(isSelected) div.classList.add('selected');

            div.innerHTML = `<span>${ex.name}</span><div class="select-check">‚úì</div>`;
            div.onclick = () => {
                if (selectedBatch.has(ex.name)) {
                    selectedBatch.delete(ex.name);
                    div.classList.remove('selected');
                } else {
                    selectedBatch.add(ex.name);
                    div.classList.add('selected');
                }
                document.querySelector('.btn-confirm-add').innerText = `Add ${selectedBatch.size} Exercises`;
            };
            container.appendChild(div);
        });
    }

    function confirmBatchAdd() {
        selectedBatch.forEach(name => {
            currentLog.push({ name: name, meta: 'Logged' });
        });
        saveState();
        renderLog();
        closeModal('modal-batch');
    }

    function renderLog() {
        const list = document.getElementById('log-list');
        const trigger = document.getElementById('add-trigger-area');
        const addMore = document.getElementById('add-more-btn');
        const scoreVal = document.getElementById('score-workout');

        list.innerHTML = '';

        if (currentLog.length === 0) {
            trigger.style.display = 'flex';
            addMore.style.display = 'none';
            scoreVal.innerText = "0 Activities";
            scoreVal.classList.remove('done');
        } else {
            trigger.style.display = 'none';
            addMore.style.display = 'block';
            scoreVal.innerText = `${currentLog.length} Activities`;
            scoreVal.classList.add('done');

            currentLog.forEach((item, idx) => {
                const li = document.createElement('li');
                li.className = 'log-item';
                li.innerHTML = `
                    <div class="log-item-name">${item.name}</div>
                    <button class="btn-delete" onclick="removeLogItem(${idx})">‚úï</button>
                `;
                list.appendChild(li);
            });
        }
    }

    function removeLogItem(idx) {
        if(confirm("Remove this exercise?")) {
            currentLog.splice(idx, 1);
            saveState();
            renderLog();
        }
    }

    // --- DATA MANAGEMENT ---
    function saveState() {
        const data = {
            date: new Date().toDateString(),
            day: document.getElementById('dayInput').value,
            log: currentLog,
            habits: habitsData,
            user: currentUser,
            other: document.getElementById('other-input').value
        };
        localStorage.setItem('nogueraFit_data', JSON.stringify(data));
        updateScorecardStatus();
    }

    function loadState() {
        const raw = localStorage.getItem('nogueraFit_data');
        if (!raw) return;
        const saved = JSON.parse(raw);
        
        // Midnight Reset
        if (saved.date !== new Date().toDateString()) {
            localStorage.removeItem('nogueraFit_data');
            localStorage.removeItem('nogueraFit_synced');
            return; 
        }

        // Restore
        document.getElementById('dayInput').value = saved.day;
        currentLog = saved.log || [];
        habitsData = saved.habits || habitsData;
        if (saved.user) selectUser(saved.user);
        if (saved.other) document.getElementById('other-input').value = saved.other;
        
        // Restore Sync Button State
        if (localStorage.getItem('nogueraFit_synced') === 'true') {
            const btn = document.getElementById('main-action-btn');
            btn.innerHTML = "üì§ Share Scorecard";
            btn.classList.add('synced');
            isSynced = true;
        }

        updateScorecardStatus();
    }

    function updateScorecardStatus() {
        // Nutrition Logic
        const total = 20; // 8+5+5+2
        const current = habitsData.water.current + habitsData.veggies.current + habitsData.fruits.current + habitsData.snacks.current;
        const nScore = document.getElementById('score-nutrition');
        
        if (current === 0) { nScore.innerText = "Not Started"; nScore.classList.remove('done'); }
        else if (current >= total) { nScore.innerText = "‚úÖ Complete"; nScore.classList.add('done'); }
        else { nScore.innerText = "In Progress"; nScore.classList.remove('done'); }
    }

    function initHabits() {
        document.querySelectorAll('.circle-row').forEach(row => {
            if(row.innerHTML !== '') return;
            const h = row.getAttribute('data-habit');
            const g = parseInt(row.getAttribute('data-goal'));
            
            for(let i=0; i<g; i++) {
                const d = document.createElement('div');
                d.className = 'habit-circle';
                d.onclick = () => {
                    const cVal = habitsData[h].current;
                    const nVal = (cVal === i+1 && i===0) ? 0 : i+1;
                    updateHabitVisuals(h, g, nVal);
                    saveState();
                };
                row.appendChild(d);
            }
            updateHabitVisuals(h, g, habitsData[h].current);
        });
    }

    function updateHabitVisuals(h, g, val) {
        habitsData[h].current = val;
        const row = document.querySelector(`.circle-row[data-habit="${h}"]`);
        const colors = { water: '#5AC8FA', veggies: '#34C759', fruits: '#FF3B30', snacks: '#AF52DE' };
        
        Array.from(row.children).forEach((c, i) => {
            if (i < val) {
                c.classList.add('active');
                c.style.background = colors[h];
            } else {
                c.classList.remove('active');
                c.style.background = 'transparent';
            }
        });
        
        document.getElementById(`count-${h}`).innerText = `${val}/${g}`;
        document.getElementById(`bar-${h}`).style.width = `${(val/g)*100}%`;
        updateScorecardStatus();
    }

    // --- LEADERBOARD ---
    async function openLeaderboard() {
        document.getElementById('leaderboard-modal').style.display = 'flex';
        document.getElementById('lb-content').innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Fetching...</div>';
        
        try {
            const res = await fetch(API_URL);
            familyData = await res.json();
            renderLeaderboard('today');
        } catch(e) { console.log(e); }
    }

    function renderLeaderboard(mode) {
        document.getElementById('lb-tab-day').classList.toggle('active', mode==='today');
        document.getElementById('lb-tab-day').style.color = mode==='today' ? 'black' : '#888';
        document.getElementById('lb-tab-streak').classList.toggle('active', mode==='streak');
        document.getElementById('lb-tab-streak').style.color = mode==='streak' ? 'black' : '#888';

        let data = [...familyData];
        if (mode === 'today') data.sort((a,b) => (a.status === 'done' ? -1 : 1));
        else data.sort((a,b) => b.streak - a.streak);

        const container = document.getElementById('lb-content');
        container.innerHTML = '';

        data.forEach((u, idx) => {
            let rankClass = 'rank-low';
            if (idx === 0) rankClass = 'rank-1';
            if (idx === 1) rankClass = 'rank-2';
            if (idx === 2) rankClass = 'rank-3';

            let statusHTML = '';
            if (mode === 'today') {
                statusHTML = u.status === 'done' 
                    ? '<span class="status-done">Worked out today</span>' 
                    : '<span class="status-pending">Not yet</span>';
            } else {
                // Format streak logic
                let s = u.streak;
                let txt = `${s} Days`;
                if (s >= 7 && s < 14) txt = "1 Week";
                if (s >= 14 && s < 21) txt = "2 Weeks";
                if (s >= 21) txt = Math.floor(s/7) + " Weeks";
                statusHTML = `<span style="font-weight:800; color:#FF9500;">üî• ${txt}</span>`;
            }

            const div = document.createElement('div');
            div.className = 'lb-row';
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div class="lb-rank ${rankClass}">${idx+1}</div>
                    <div class="lb-name">${u.name}</div>
                </div>
                <div class="lb-status">${statusHTML}</div>
            `;
            container.appendChild(div);
        });
    }

    // --- UI HELPERS ---
    function selectUser(name) {
        currentUser = name;
        document.getElementById('header-username').innerText = "üë§ " + name;
        closeModal('modal-user');
        saveState();
    }
    
    function updateProgressUI() {
        const d = document.getElementById('dayInput').value;
        document.getElementById('visual-progress').style.width = d + '%';
        document.getElementById('progress-text').innerText = d + '%';
        saveState();
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        if(t === 'workout') {
            document.getElementById('workout-view').classList.remove('hidden-view');
            document.getElementById('nutrition-view').classList.add('hidden-view');
        } else {
            document.getElementById('workout-view').classList.add('hidden-view');
            document.getElementById('nutrition-view').classList.remove('hidden-view');
        }
    }

    function openBarcode() { document.getElementById('modal-barcode').style.display = 'flex'; }
    function openUserModal() { document.getElementById('modal-user').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
