<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NogueraFit</title>
    
    <link rel="apple-touch-icon" href="images/icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- iOS DESIGN SYSTEM --- */
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-gray: #F2F2F7;
            --ios-gold: #FFD700;
            --text-dark: #1C1C1E;
            --text-light: #8E8E93;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-gray);
            margin: 0;
            padding: 0;
            padding-bottom: 90px; /* Space for nav */
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADERS */
        .header {
            padding: 50px 20px 10px 20px;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 0 rgba(0,0,0,0.05);
        }
        .header h1 {
            margin: 0;
            font-size: 34px;
            font-weight: 800;
            letter-spacing: -0.5px;
            color: var(--text-dark);
        }
        .header p {
            margin: 5px 0 0;
            color: var(--text-light);
            font-size: 15px;
        }

        /* CARDS */
        .card {
            background: #fff;
            margin: 20px;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin: 0 0 15px 0;
            color: var(--text-dark);
        }

        /* INPUTS */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #E5E5EA;
            border-radius: 12px;
            font-size: 17px;
            background: #F9F9F9;
            appearance: none;
            -webkit-appearance: none;
        }
        input:focus { outline: 2px solid var(--ios-blue); border-color: transparent; }

        /* BUTTONS */
        .btn-primary {
            width: 100%;
            padding: 18px;
            background-color: var(--ios-blue);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 600;
            margin-top: 10px;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .btn-primary:active { transform: scale(0.98); opacity: 0.9; }

        /* TABS */
        .tab-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 10px 0 25px 0;
            z-index: 1000;
        }
        .tab-btn {
            background: none;
            border: none;
            color: #C7C7CC;
            font-size: 10px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .tab-btn.active { color: var(--ios-blue); }
        .tab-icon { font-size: 24px; }

        /* LEADERBOARD */
        .lb-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #F2F2F7;
            cursor: pointer; /* Suggests clickability */
        }
        .lb-row:last-child { border-bottom: none; }
        .lb-rank {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            margin-right: 12px;
        }
        .rank-1 { background: var(--ios-gold); color: white; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); }
        .rank-2 { background: #E0E0E0; color: #555; }
        .rank-3 { background: #CD7F32; color: white; }
        .rank-low { color: var(--text-light); font-weight: 500; }

        .lb-name { font-weight: 600; font-size: 16px; color: var(--text-dark); }
        .lb-sub { font-size: 12px; color: var(--text-light); margin-top: 2px; }
        
        .lb-stat-box { text-align: right; }
        .lb-val-main { font-weight: 700; font-size: 16px; color: var(--text-dark); }
        .lb-val-sub { font-size: 11px; color: var(--text-light); text-transform: uppercase; }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: flex-end; /* Slide up from bottom */
        }
        .modal-content {
            background: #F2F2F7;
            width: 100%;
            max-width: 600px;
            border-radius: 20px 20px 0 0;
            padding: 24px;
            animation: slideUp 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 22px; font-weight: 700; }
        .btn-close { background: #E5E5EA; border: none; width: 32px; height: 32px; border-radius: 50%; font-weight: 700; color: #555; }

        /* PROGRESS BAR */
        .progress-cont { height: 12px; background: #E5E5EA; border-radius: 6px; overflow: hidden; margin: 15px 0; }
        .progress-fill { height: 100%; background: var(--ios-green); width: 0%; transition: width 0.5s ease; }

        /* HABIT TRACKER GRID */
        .habit-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 10px; }
        .habit-dot { 
            height: 8px; background: #E5E5EA; border-radius: 4px; 
        }
        .habit-dot.active { background: var(--ios-blue); }

        /* USER SELECTION GRID */
        .user-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .user-card {
            background: white; padding: 20px; border-radius: 16px; text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer;
        }
        .user-avatar { 
            width: 50px; height: 50px; background: var(--ios-blue); color: white; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 20px; font-weight: 700; margin: 0 auto 10px auto;
        }

        .hidden-view { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h1>NogueraFit</h1>
        <p id="date-display">Loading...</p>
    </div>

    <div id="workout-view">
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <span class="section-title">Challenge Progress</span>
                <span style="color:var(--ios-blue); font-weight:600;" id="progress-text">0%</span>
            </div>
            <div class="progress-cont">
                <div class="progress-fill" id="visual-progress"></div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:14px; color:#8E8E93;">Day <span id="day-number">1</span> of 75</span>
                <button onclick="document.getElementById('modal-day').style.display='flex'" style="border:none; background:none; color:var(--ios-blue); font-weight:600; font-size:14px;">Edit Day</button>
            </div>
        </div>

        <div class="card">
            <div class="section-title">Leaderboard</div>
            <div id="lb-container">
                <div style="text-align:center; padding:20px; color:#aaa;">Loading...</div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">Log Workout</div>
            <select id="location">
                <option value="Home">üè† Home</option>
                <option value="Gym">üèãÔ∏è Gym</option>
                <option value="Run">üèÉ Run</option>
            </select>
            <input type="text" id="exercises" placeholder="Describe workout (e.g., 5k Run, PPL)">
            <button class="btn-primary" onclick="submitData()">Log Workout</button>
        </div>
    </div>

    <div id="nutrition-view" class="hidden-view">
        <div class="card">
            <div class="section-title">Daily Habits</div>
            
            <div style="margin-bottom:25px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="font-weight:600;">üíß Water (L)</span>
                    <span style="color:var(--text-light); font-size:14px;" id="count-water">0/4</span>
                </div>
                <div class="habit-grid" id="grid-water"></div>
                <div style="margin-top:10px; display:flex; gap:10px;">
                    <button onclick="updateHabit('water', 1)" style="flex:1; padding:8px; background:#E5E5EA; border:none; border-radius:8px;">+ 250ml</button>
                    <button onclick="updateHabit('water', -1)" style="width:40px; background:#E5E5EA; border:none; border-radius:8px;">-</button>
                </div>
            </div>

            <div style="margin-bottom:25px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="font-weight:600;">ü•© Protein (g)</span>
                    <span style="color:var(--text-light); font-size:14px;" id="count-protein">0/160</span>
                </div>
                <div style="background:#E5E5EA; height:8px; border-radius:4px; overflow:hidden;">
                    <div id="bar-protein" style="width:0%; height:100%; background:var(--ios-blue); transition:width 0.3s;"></div>
                </div>
                <div style="margin-top:10px; display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                    <button onclick="updateHabit('protein', 10)" style="padding:8px; background:#E5E5EA; border:none; border-radius:8px;">+10g</button>
                    <button onclick="updateHabit('protein', 25)" style="padding:8px; background:#E5E5EA; border:none; border-radius:8px;">+25g</button>
                    <button onclick="openBarcode()" style="padding:8px; background:var(--ios-blue); color:white; border:none; border-radius:8px;">üì∑ Scan</button>
                </div>
            </div>

            <div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span style="font-weight:600;">ü•¶ Veggies / Fruits</span>
                    <span style="color:var(--text-light); font-size:14px;" id="count-veg">0/5</span>
                </div>
                <div class="habit-grid" id="grid-veg"></div>
                <button onclick="updateHabit('veg', 1)" style="width:100%; margin-top:10px; padding:10px; background:#E5E5EA; border:none; border-radius:8px;">+ 1 Serving</button>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <button class="tab-btn active" id="tab-workout" onclick="switchTab('workout')">
            <span class="tab-icon">üí™</span>
            <span>Workout</span>
        </button>
        <button class="tab-btn" id="tab-nutrition" onclick="switchTab('nutrition')">
            <span class="tab-icon">ü•ó</span>
            <span>Nutrition</span>
        </button>
    </div>

    <div id="modal-user" class="modal-overlay">
        <div class="modal-content" style="height:auto; text-align:center;">
            <div class="modal-title" style="margin-bottom:20px;">Who is this?</div>
            <div class="user-grid" id="user-list">
                </div>
        </div>
    </div>

    <div id="modal-barcode" class="modal-overlay" onclick="closeModal('modal-barcode')">
        <div class="modal-content" style="height:40vh; text-align:center; justify-content:center;" onclick="event.stopPropagation()">
            <div style="font-size:40px; margin-bottom:20px;">üì∑</div>
            <div class="section-title">Scanner Active</div>
            <p>Simulating barcode scan...</p>
            <button class="btn-primary" onclick="updateHabit('protein', 25); closeModal('modal-barcode')">Add Scanned Item (25g)</button>
        </div>
    </div>

    <div id="modal-day" class="modal-overlay" onclick="closeModal('modal-day')">
        <div class="modal-content" onclick="event.stopPropagation()" style="height:auto;">
            <div class="modal-header">
                <div class="modal-title">Adjust Day</div>
                <button class="btn-close" onclick="closeModal('modal-day')">‚úï</button>
            </div>
            <input type="number" id="dayInput" placeholder="Enter Day Number (1-75)">
            <button class="btn-primary" onclick="manualSetDay()">Save</button>
        </div>
    </div>

    <div id="modal-stats" class="modal-overlay" onclick="closeModal('modal-stats')">
        <div class="modal-content" onclick="event.stopPropagation()" style="height: 70vh;">
            <div class="modal-header">
                <div class="modal-title" id="stats-username">Player Stats</div>
                <button class="btn-close" onclick="closeModal('modal-stats')">‚úï</button>
            </div>

            <div style="display:flex; justify-content:space-between; margin-bottom:20px; gap:10px;">
                <div style="flex:1; background:white; padding:15px 10px; border-radius:16px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                    <div style="font-size:24px; font-weight:800; color:#1C1C1E;" id="stat-total">-</div>
                    <div style="font-size:10px; font-weight:700; color:#8E8E93; text-transform:uppercase; margin-top:4px;">Workouts</div>
                </div>
                <div style="flex:1; background:white; padding:15px 10px; border-radius:16px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                    <div style="font-size:24px; font-weight:800; color:#007AFF;" id="stat-current">-</div>
                    <div style="font-size:10px; font-weight:700; color:#8E8E93; text-transform:uppercase; margin-top:4px;">Streak</div>
                </div>
                <div style="flex:1; background:white; padding:15px 10px; border-radius:16px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.03);">
                    <div style="font-size:24px; font-weight:800; color:#FF9500;" id="stat-best">-</div>
                    <div style="font-size:10px; font-weight:700; color:#8E8E93; text-transform:uppercase; margin-top:4px;">Best</div>
                </div>
            </div>

            <div class="section-title" style="margin-top:0;">üèÜ Top Exercises</div>
            <div id="stats-top-list" style="flex:1; overflow-y:auto;">
                <div style="text-align:center; padding:20px; color:#aaa;">Loading data...</div>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const API_URL = "https://script.google.com/macros/s/AKfycbyvkTq3EIZcmI8LnXIcJ0pX0WlC_7gkkoQHqpVP0Nj4pM8vzEgGEmed_8j5H-TOckmn/exec";
    
    const FAMILY_NAMES = ['Papi', 'Mami', 'Caro', 'Ceci', 'Sofi', 'Matu', 'Andi'];
    let currentUser = localStorage.getItem('nogueraUser');
    let familyData = [];
    
    // NUTRITION STATE
    let nutrition = {
        water: 0,
        protein: 0,
        veg: 0
    };
    const GOALS = { water: 16, protein: 160, veg: 5 }; // Water stored as "chunks" of 250ml (4L = 16 chunks)

    // --- INITIALIZATION ---
    window.onload = function() {
        const d = new Date();
        document.getElementById('date-display').innerText = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
        
        initHabit grids();
        
        if (!currentUser) {
            initUserSelection();
            openUserModal();
        } else {
            fetchFamilyData(); // Initial Load
        }
    };

    function initUserSelection() {
        const grid = document.getElementById('user-list');
        grid.innerHTML = '';
        FAMILY_NAMES.forEach(name => {
            const div = document.createElement('div');
            div.className = 'user-card';
            div.innerHTML = `<div class="user-avatar">${name.charAt(0)}</div><div style="font-weight:600;">${name}</div>`;
            div.onclick = () => selectUser(name);
            grid.appendChild(div);
        });
    }

    function selectUser(name) {
        currentUser = name;
        localStorage.setItem('nogueraUser', name);
        closeModal('modal-user');
        fetchFamilyData();
    }

    // --- CORE LOGIC ---

    async function fetchFamilyData() {
        const cont = document.getElementById('lb-container');
        try {
            // Updated to use the correct View
            const res = await fetch(API_URL + "?view=leaderboard");
            const rawData = await res.json();
            
            // Map raw data to our family list
            familyData = FAMILY_NAMES.map(name => {
                const found = rawData.find(r => r.Name === name);
                if (found) {
                    return { 
                        name: name, 
                        streak: found['Days Active'], 
                        lastDate: found['Last Date'],
                        status: 'active'
                    };
                }
                return { name: name, streak: 0, lastDate: 0, status: 'pending' };
            });

            if(currentUser) autoSetDay(currentUser);
            renderLeaderboardCard();
        } catch(e) { 
            console.log(e); 
            cont.innerHTML = "<div style='text-align:center; padding:20px;'>Offline Mode</div>";
        }
    }

    // FIXED: Moved outside to global scope to prevent crashes
    function renderLeaderboardCard() {
        const container = document.getElementById('lb-container');
        container.innerHTML = '';
        familyData.sort((a,b) => b.streak - a.streak);

        familyData.forEach((u, idx) => {
            let rankClass = 'rank-low';
            if (idx === 0) rankClass = 'rank-1';
            if (idx === 1) rankClass = 'rank-2';
            if (idx === 2) rankClass = 'rank-3';

            let lastText = "Last: Never";
            if (u.lastDate && u.lastDate > 0) {
                const daysAgo = Math.floor((new Date() - new Date(u.lastDate)) / (1000 * 60 * 60 * 24));
                lastText = daysAgo === 0 ? "Last: Today" : `Last: ${daysAgo}d ago`;
            }

            const isMe = (u.name === currentUser);
            const nameStyle = isMe ? 'color: var(--ios-blue);' : 'color: #1C1C1E;';
            const nameSuffix = isMe ? ' <span style="font-weight:400; font-size:13px; color:#8E8E93; margin-left:4px;">(You)</span>' : '';

            const div = document.createElement('div');
            div.className = 'lb-row';
            // Added Click Handler for Stats
            div.onclick = () => openStatsModal(u.name);
            
            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <div class="lb-rank ${rankClass}">${idx+1}</div>
                    <div class="lb-details">
                        <div class="lb-name" style="${nameStyle}">${u.name}${nameSuffix}</div>
                        <div class="lb-sub">${lastText}</div>
                    </div>
                </div>
                <div class="lb-stat-box">
                    <div class="lb-val-main">${u.streak}</div>
                    <div class="lb-val-sub">Days</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    async function submitData() {
        const loc = document.getElementById('location').value;
        const ex = document.getElementById('exercises').value;
        const btn = document.querySelector('.btn-primary');

        if (!currentUser) return alert("Please select user first!");
        if (!ex) return alert("Please enter exercises");

        // Combine Workout + Nutrition for storage
        // Format: "Bench Press, Run | W:8, V:3, P:140"
        const nutritionString = ` | W:${nutrition.water}, V:${nutrition.veg}, P:${nutrition.protein}`;
        const finalString = ex + nutritionString;

        const payload = {
            date: new Date(),
            day: document.getElementById('day-number').innerText,
            name: currentUser,
            location: loc,
            workout: finalString
        };

        btn.innerText = "Saving...";
        btn.disabled = true;

        try {
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            // Trigger Confetti
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            
            document.getElementById('exercises').value = '';
            btn.innerText = "Log Workout";
            btn.disabled = false;
            
            // Refresh data
            setTimeout(fetchFamilyData, 1000);

        } catch (e) {
            alert("Error saving: " + e);
            btn.innerText = "Log Workout";
            btn.disabled = false;
        }
    }

    // --- DAY CALCULATOR ---
    function calculateDay() {
        const start = new Date("2026-01-26"); // START DATE
        const now = new Date();
        const diff = now - start;
        const day = Math.floor(diff / (1000 * 60 * 60 * 24)) + 1;
        return day > 0 ? day : 1;
    }

    function autoSetDay(user) {
        // If user already logged today, maybe we don't increment? 
        // For now, just using standard date logic
        const d = calculateDay();
        document.getElementById('day-number').innerText = d;
        document.getElementById('dayInput').value = d;
        
        // Update Visual Bar
        const pct = Math.min((d / 75) * 100, 100).toFixed(0);
        document.getElementById('visual-progress').style.width = pct + '%';
        document.getElementById('progress-text').innerText = pct + '%';
    }

    function manualSetDay() {
        const d = document.getElementById('dayInput').value;
        document.getElementById('day-number').innerText = d;
        const pct = Math.min((d / 75) * 100, 100).toFixed(0);
        document.getElementById('visual-progress').style.width = pct + '%';
        document.getElementById('progress-text').innerText = pct + '%';
        closeModal('modal-day');
    }

    // --- NUTRITION LOGIC ---
    function initHabit() {
        createGrid('water', 16); // 4L = 16 x 250ml
        createGrid('veg', 5);
    }
    
    function createGrid(type, count) {
        const cont = document.getElementById('grid-'+type); // Should be initHabit not initHabit grids
        // Fixed syntax error in caller
    }
    
    // Correcting the init function logic below:
    function initHabit() {
        // Grid for water (16 dots)
        const wC = document.getElementById('grid-water');
        wC.innerHTML = '';
        for(let i=0; i<16; i++) {
            let d = document.createElement('div');
            d.className = 'habit-dot';
            d.id = `water-dot-${i}`;
            wC.appendChild(d);
        }

        // Grid for Veg (5 dots)
        const vC = document.getElementById('grid-veg');
        vC.innerHTML = '';
        for(let i=0; i<5; i++) {
            let d = document.createElement('div');
            d.className = 'habit-dot';
            d.id = `veg-dot-${i}`;
            vC.appendChild(d);
        }
    }

    function updateHabit(type, change) {
        nutrition[type] += change;
        if(nutrition[type] < 0) nutrition[type] = 0;
        
        // Update UI
        if(type === 'water') {
            updateGridUI('water', nutrition[type], 16);
        } else if(type === 'veg') {
            updateGridUI('veg', nutrition[type], 5);
        } else if(type === 'protein') {
            document.getElementById('count-protein').innerText = `${nutrition[type]}/160`;
            const pct = Math.min((nutrition[type]/160)*100, 100);
            document.getElementById('bar-protein').style.width = pct + '%';
        }
    }

    function updateGridUI(type, val, max) {
        document.getElementById(`count-${type}`).innerText = `${val}/${max}`;
        for(let i=0; i<max; i++) {
            const el = document.getElementById(`${type}-dot-${i}`);
            if(i < val) el.classList.add('active');
            else el.classList.remove('active');
        }
    }

    // --- NEW STATS LOGIC ---
    function openStatsModal(username) {
        document.getElementById('modal-stats').style.display = 'flex';
        document.getElementById('stats-username').innerText = username + "'s Stats";
        
        // Reset UI
        document.getElementById('stat-total').innerText = "-";
        document.getElementById('stat-current').innerText = "-";
        document.getElementById('stat-best').innerText = "-";
        document.getElementById('stats-top-list').innerHTML = "<div style='text-align:center; padding:20px; color:#aaa;'>Loading...</div>";
        
        fetchUserStats(username);
    }

    async function fetchUserStats(username) {
        try {
            const res = await fetch(API_URL + "?view=profile&user=" + username);
            const data = await res.json();
            
            // Render Exercises
            const listCont = document.getElementById('stats-top-list');
            listCont.innerHTML = '';
            
            if(data.topExercises.length === 0) {
                listCont.innerHTML = "<div style='text-align:center; padding:20px; color:#aaa;'>No exercises logged yet.</div>";
            } else {
                data.topExercises.slice(0, 20).forEach((ex, i) => {
                    const row = document.createElement('div');
                    row.className = 'lb-row';
                    row.innerHTML = `
                        <div style="display:flex; align-items:center;">
                            <div class="lb-rank rank-low" style="background:#E5E5EA; color:#555;">${i+1}</div>
                            <div class="lb-name" style="font-size:14px;">${ex.name}</div>
                        </div>
                        <div class="lb-val-main" style="font-size:14px;">${ex.count}</div>
                    `;
                    listCont.appendChild(row);
                });
            }

            // Calculate Streaks
            const streakData = calculateStreaks(data.history);
            document.getElementById('stat-total').innerText = data.history.length;
            document.getElementById('stat-current').innerText = streakData.current;
            document.getElementById('stat-best').innerText = streakData.longest;

        } catch(e) { console.log("Error loading stats:", e); }
    }

    function calculateStreaks(dateStrings) {
        if (!dateStrings || dateStrings.length === 0) return { current: 0, longest: 0 };

        const timestamps = dateStrings.map(d => new Date(d).setHours(0,0,0,0)).sort((a,b) => b - a);
        const uniqueDates = [...new Set(timestamps)];

        let current = 0;
        let longest = 0;
        let tempStreak = 0;
        
        const today = new Date().setHours(0,0,0,0);
        const yesterday = today - 86400000;

        // Longest Streak
        for (let i = 0; i < uniqueDates.length; i++) {
            if (i === 0) tempStreak = 1;
            else {
                const diff = (uniqueDates[i-1] - uniqueDates[i]) / 86400000;
                if (diff === 1) tempStreak++;
                else {
                    if (tempStreak > longest) longest = tempStreak;
                    tempStreak = 1;
                }
            }
        }
        if (tempStreak > longest) longest = tempStreak;

        // Current Streak
        if (uniqueDates[0] === today || uniqueDates[0] === yesterday) {
            current = 1;
            for (let i = 0; i < uniqueDates.length - 1; i++) {
                const diff = (uniqueDates[i] - uniqueDates[i+1]) / 86400000;
                if (diff === 1) current++;
                else break;
            }
        }

        return { current, longest };
    }

    // --- UTILS ---
    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-'+t).classList.add('active');
        if(t === 'workout') {
            document.getElementById('workout-view').classList.remove('hidden-view');
            document.getElementById('nutrition-view').classList.add('hidden-view');
        } else {
            document.getElementById('workout-view').classList.add('hidden-view');
            document.getElementById('nutrition-view').classList.remove('hidden-view');
        }
    }

    function openBarcode() { document.getElementById('modal-barcode').style.display = 'flex'; }
    function openUserModal() { document.getElementById('modal-user').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    // Correct init call
    function initHabit(){
        const wC = document.getElementById('grid-water');
        wC.innerHTML = '';
        for(let i=0; i<16; i++) {
            let d = document.createElement('div');
            d.className = 'habit-dot';
            d.id = `water-dot-${i}`;
            wC.appendChild(d);
        }

        const vC = document.getElementById('grid-veg');
        vC.innerHTML = '';
        for(let i=0; i<5; i++) {
            let d = document.createElement('div');
            d.className = 'habit-dot';
            d.id = `veg-dot-${i}`;
            vC.appendChild(d);
        }
    }
</script>
</body>
</html>
