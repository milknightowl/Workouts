<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NogueraFit</title>
    
    <link rel="apple-touch-icon" href="images/icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F2F2F7">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* --- iOS DESIGN SYSTEM --- */
        :root {
            --ios-blue: #007AFF;
            --ios-green: #34C759;
            --ios-gray: #8E8E93;
            --ios-bg: #F2F2F7;
            --text-dark: #1C1C1E;
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--ios-bg);
            margin: 0;
            padding: 0;
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
        }

        .app-content {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            padding-bottom: 50px;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 5px; }
        .user-select-btn { background: none; border: none; font-size: 18px; font-weight: 700; color: var(--ios-blue); display: flex; align-items: center; gap: 6px; cursor: pointer; padding: 0; }
        .btn-barcode { background: white; border: none; padding: 6px 12px; border-radius: 14px; font-size: 13px; font-weight: 700; color: #555; cursor: pointer; display: flex; align-items: center; gap: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* --- PROGRESS --- */
        .progress-wrapper { background: white; padding: 15px; border-radius: 18px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .progress-header { display: flex; justify-content: space-between; font-size: 12px; font-weight: 700; color: var(--ios-gray); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .progress-container { width: 100%; background-color: #E5E5EA; border-radius: 6px; height: 10px; overflow: hidden; margin-bottom: 12px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--ios-blue), #5AC8FA); width: 1%; transition: width 0.5s ease; border-radius: 6px; }
        .day-controls { display: flex; align-items: center; justify-content: center; font-size: 15px; font-weight: 600; }
        .day-select { font-size: 16px; font-weight: 800; color: var(--text-dark); border: none; background: #F2F2F7; padding: 4px 10px; border-radius: 8px; margin: 0 8px; text-align: center; }

        /* --- CAROUSEL --- */
        .carousel-track { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; gap: 15px; padding-bottom: 10px; margin: 0 -15px; padding: 0 15px 20px 15px; -ms-overflow-style: none; scrollbar-width: none; }
        .carousel-track::-webkit-scrollbar { display: none; }
        .card-slide { flex: 0 0 92%; scroll-snap-align: center; background: white; border-radius: 24px; padding: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.06); position: relative; border: 1px solid rgba(0,0,0,0.02); overflow: hidden; transition: transform 0.6s; transform-style: preserve-3d; }
        .carousel-dots { display: flex; justify-content: center; gap: 8px; margin-bottom: 25px; margin-top: -10px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #D1D1D6; transition: 0.2s; }
        .dot.active { background: var(--ios-blue); transform: scale(1.2); }

        /* --- SCORECARD STATES --- */
        /* Empty State (Gray) */
        .state-empty .scorecard-header::before { background-color: #C7C7CC; } 
        .state-empty .scorecard-date { background: #E5E5EA; color: #8E8E93; }
        
        /* Active State (Blue) */
        .state-active .scorecard-header::before { background-color: var(--ios-blue); }
        .state-active .scorecard-date { background: rgba(0,122,255,0.1); color: var(--ios-blue); }

        /* Submitted State (Green) */
        .state-submitted .scorecard-header::before { background-color: var(--ios-green); }
        .state-submitted .scorecard-date { background: rgba(52, 199, 89, 0.15); color: var(--ios-green); }

        .scorecard-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 15px; position: relative; z-index: 2; margin-top: 5px; padding-top: 10px; }
        .scorecard-header::before { content: ""; position: absolute; top: -20px; left: -20px; right: -20px; height: 6px; z-index:1; transition: background 0.3s; }
        
        .scorecard-title { font-size: 22px; font-weight: 800; color: #1C1C1E; }
        .scorecard-date { font-size: 12px; font-weight: 700; text-transform: uppercase; padding: 4px 10px; border-radius: 20px; transition: 0.3s; }
        
        .score-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 6px 0; border-bottom: 1px dashed #F2F2F7; font-size: 15px; }
        .score-label { font-weight: 600; color: #666; display: flex; align-items: center; gap: 6px; }
        .score-val { font-weight: 700; color: #1C1C1E; }
        .score-val.done { color: var(--ios-green); }

        /* Submit Button inside Card */
        .card-footer-btn { 
            width: 100%; padding: 14px; border-radius: 12px; font-weight: 700; font-size: 16px; margin-top: 10px; 
            border: none; cursor: pointer; transition: 0.2s; display: none; /* Hidden by default */
        }
        .btn-submit-day { background: var(--ios-blue); color: white; box-shadow: 0 4px 10px rgba(0,122,255,0.3); }
        .btn-submit-day:active { transform: scale(0.98); }
        
        .msg-locked { display: none; text-align: center; color: var(--ios-green); font-weight: 700; margin-top: 15px; font-size: 14px; }
        .btn-unlock { display: block; margin: 10px auto 0; background: none; border: none; color: #8E8E93; text-decoration: underline; font-size: 12px; cursor: pointer; }

        /* --- DASHBOARD ACTION GRID --- */
        .action-grid { display: flex; gap: 15px; margin-bottom: 25px; transition: opacity 0.3s; }
        .action-grid.hidden { display: none; } /* Hide when submitted */
        
        .dash-btn { flex: 1; background: white; border: none; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .dash-btn:active { transform: scale(0.96); background: #F2F2F7; }
        .btn-icon { font-size: 32px; display: block; }
        .btn-label { font-weight: 700; font-size: 15px; color: #1C1C1E; }

        /* --- TODAY'S LOG --- */
        .today-section { margin-top: 10px; }
        .section-title { font-size: 14px; font-weight: 700; color: #8E8E93; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; }
        .log-item { background: white; padding: 15px; border-radius: 16px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; font-size: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); margin-bottom: 10px; }
        .log-left { display: flex; align-items: center; gap: 10px; }
        .log-check { color: var(--ios-green); font-size: 18px; }
        .btn-delete-log { color: #FF3B30; background: none; border: none; font-weight: 700; font-size: 18px; padding: 5px 10px; cursor: pointer; }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-content { background: #F2F2F7; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; padding: 25px; height: 90vh !important; display: flex; flex-direction: column; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal-content--auto { height: auto !important; max-height: 80vh !important; border-radius: 24px; max-width: 340px; margin: auto; animation: scaleIn 0.2s ease-out !important; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0; }
        .modal-title { font-size: 20px; font-weight: 800; }
        .btn-close { background: #E5E5EA; border: none; width: 30px; height: 30px; border-radius: 50%; color: #555; font-weight: bold; cursor: pointer; }

        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- UNIFIED LIST (No Tabs) --- */
        .search-bar { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #D1D1D6; font-size: 16px; margin-bottom: 15px; background: white; }
        .unified-list { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        
        .list-section-header { font-size: 13px; font-weight: 800; color: #8E8E93; text-transform: uppercase; margin: 20px 0 8px 5px; position: sticky; top: -1px; background: #F2F2F7; padding: 5px; z-index: 10; }
        
        .select-item { background: white; padding: 10px 15px; border-radius: 14px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; min-height: 60px; margin-bottom: 8px; }
        .select-item:active { transform: scale(0.99); }
        
        .item-left { display: flex; align-items: center; gap: 15px; }
        .item-img { width: 50px; height: 50px; object-fit: contain; mix-blend-mode: multiply; }
        .item-check-circle { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #D1D1D6; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        .select-item.selected .item-check-circle { background: var(--ios-blue); border-color: var(--ios-blue); }
        .select-item.selected .item-check-circle::after { content: "‚úì"; color: white; font-size: 14px; font-weight: bold; }

        .btn-fab-add { position: absolute; bottom: 90px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: var(--ios-blue); color: white; border: none; font-size: 24px; font-weight: 300; box-shadow: 0 4px 12px rgba(0,122,255,0.4); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 50; }

        .btn-confirm-add { width: 100%; padding: 18px; background: var(--ios-blue); color: white; font-weight: 700; border-radius: 16px; border: none; margin-top: auto; cursor: pointer; font-size: 16px; box-shadow: 0 -10px 20px #F2F2F7; z-index: 60; }

        /* --- PREVIEW CARD (Generator) --- */
        .preview-card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; }
        .preview-list { margin: 15px 0; border-top: 1px solid #EEE; }
        .preview-item { padding: 10px 0; border-bottom: 1px solid #EEE; display: flex; align-items: center; gap: 10px; font-size: 15px; }

        /* --- HABITS --- */
        .habit-card { background: white; border-radius: 18px; padding: 18px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .habit-header { display: flex; justify-content: space-between; margin-bottom: 12px; align-items: center; }
        .habit-title { font-weight: 700; font-size: 16px; }
        .habit-count { font-size: 14px; font-weight: 600; color: #888; background: #f2f2f7; padding: 3px 8px; border-radius: 6px; }
        .circle-row { display: flex; gap: 8px; }
        .habit-circle { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #E5E5EA; cursor: pointer; transition: 0.2s; }
        .habit-circle.active { transform: scale(1.1); border-color: transparent; }
        .bg-water { background: #5AC8FA; } .bg-veggie { background: #34C759; } .bg-fruit { background: #FF3B30; } .bg-snack { background: #AF52DE; }

        /* LEADERBOARD STYLES */
        .lb-headers { display: flex; justify-content: space-between; font-size: 11px; font-weight: 700; color: #8E8E93; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #F2F2F7; padding-bottom: 5px; margin-top: 20px; }
        .lb-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F2F2F7; }
        .lb-rank { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: 800; border-radius: 50%; font-size: 13px; margin-right: 8px; }
        .rank-1 { background: #FFD700; color: #B48902; } .rank-2 { background: #C0C0C0; color: #555; } .rank-3 { background: #CD7F32; color: #6A3906; } .rank-low { background: #F2F2F7; color: #8E8E93; font-size: 11px; }

    </style>
</head>
<body>

    <div class="app-content">
        <div class="top-nav">
            <button class="user-select-btn" onclick="openUserModal()">
                <span id="header-username">üë• Select Team</span> <span>‚ñº</span>
            </button>
            <button class="btn-barcode" onclick="openBarcode()">Gym Pass</button>
        </div>

        <div class="progress-wrapper">
            <div class="progress-header"><span>Challenge Progress</span><span id="progress-text">0%</span></div>
            <div class="progress-container"><div id="visual-progress" class="progress-fill"></div></div>
            <div class="day-controls">
                Day <select id="dayInput" class="day-select" onchange="updateProgressUI()"></select> of 100
            </div>
        </div>

        <div class="carousel-track" id="carousel-track">
            
            <div id="main-scorecard" class="card-slide state-empty">
                <div class="scorecard-header">
                    <div class="scorecard-title" id="score-title">Scorecard</div>
                    <div class="scorecard-date" id="score-status-pill">Empty</div>
                </div>
                
                <div class="score-row"><span class="score-label">üèãÔ∏è Exercise</span><span class="score-val" id="score-workout">0 Done</span></div>
                <div class="score-row"><span class="score-label">üíß Water</span><span class="score-val" id="score-water">0 / 8</span></div>
                <div class="score-row"><span class="score-label">ü•¶ Veggies</span><span class="score-val" id="score-veggies">0 / 5</span></div>
                <div class="score-row"><span class="score-label">üçé Fruits</span><span class="score-val" id="score-fruits">0 / 5</span></div>
                <div class="score-row"><span class="score-label">ü•ú Snacks</span><span class="score-val" id="score-snacks">0 / 2</span></div>
                
                <button id="btn-submit" class="card-footer-btn btn-submit-day" onclick="submitScorecard()">Submit Scorecard</button>
                
                <div id="msg-locked" class="msg-locked">
                    <div>‚úÖ Day Complete!</div>
                    <button class="btn-unlock" onclick="unlockDay()">Not done yet? Edit</button>
                </div>
            </div>

            <div class="card-slide leaderboard-bg">
                <div class="scorecard-header">
                    <div class="scorecard-title">Family Rankings</div>
                    <div class="scorecard-date" onclick="fetchFamilyData()" style="cursor:pointer; background:#FFF8E1; color:#FF9500;">‚Üª</div>
                </div>
                <div class="lb-headers"><span>Rank / Name</span><span>Total Days Logged</span></div>
                <div id="lb-container" class="lb-list"><div style="text-align:center; padding:20px; color:#aaa;">Loading...</div></div>
            </div>
        </div>

        <div class="carousel-dots">
            <div class="dot active" id="dot-0"></div>
            <div class="dot" id="dot-1"></div>
        </div>

        <div id="action-area" class="action-grid">
            <button class="dash-btn" onclick="openWorkoutWizard()">
                <span class="btn-icon">üèãÔ∏è</span>
                <span class="btn-label">Log Workout</span>
            </button>
            <button class="dash-btn" onclick="openNutritionModal()">
                <span class="btn-icon">ü•ó</span>
                <span class="btn-label">Update Nutrition</span>
            </button>
        </div>

        <div class="today-section">
            <div class="section-title">Today's Activity</div>
            <div id="today-log-list" class="log-list"></div>
        </div>

    </div>

    <div id="modal-nutrition" class="modal-overlay" onclick="closeModal('modal-nutrition')">
        <div class="modal-content" style="height: auto !important; max-height: 80vh;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Daily Habits</div>
                <button class="btn-close" onclick="closeModal('modal-nutrition')">‚úï</button>
            </div>
            <div style="overflow-y:auto;">
                <div class="habit-card">
                    <div class="habit-header"><span class="habit-title">üíß Water Intake</span><span class="habit-count" id="count-water">0/8</span></div>
                    <div class="circle-row" data-habit="water" data-goal="8"></div>
                </div>
                <div class="habit-card">
                    <div class="habit-header"><span class="habit-title">ü•¶ Veggies</span><span class="habit-count" id="count-veggies">0/5</span></div>
                    <div class="circle-row" data-habit="veggies" data-goal="5"></div>
                </div>
                <div class="habit-card">
                    <div class="habit-header"><span class="habit-title">üçé Fruits</span><span class="habit-count" id="count-fruits">0/5</span></div>
                    <div class="circle-row" data-habit="fruits" data-goal="5"></div>
                </div>
                <div class="habit-card">
                    <div class="habit-header"><span class="habit-title">ü•ú Healthy Snacks</span><span class="habit-count" id="count-snacks">0/2</span></div>
                    <div class="circle-row" data-habit="snacks" data-goal="2"></div>
                </div>
            </div>
            <button class="btn-confirm-add" onclick="closeModal('modal-nutrition')">Done</button>
        </div>
    </div>

    <div id="modal-wizard" class="modal-overlay" onclick="closeModal('modal-wizard')" style="align-items:center;">
        <div class="modal-content modal-content--auto" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Log Workout</div><button class="btn-close" onclick="closeModal('modal-wizard')">‚úï</button></div>
            
            <div class="dash-btn" onclick="startManualLog()" style="flex-direction:row; justify-content:flex-start; margin-bottom:15px; width:100%;">
                <div class="btn-icon" style="font-size:24px; background:#E3F2FD; padding:10px; border-radius:50%;">üìù</div>
                <div style="text-align:left;">
                    <span class="btn-label">Manual Log</span>
                    <div style="font-size:12px; color:#888;">Select from list</div>
                </div>
            </div>

            <div class="dash-btn" onclick="startGenerator()" style="flex-direction:row; justify-content:flex-start; width:100%;">
                <div class="btn-icon" style="font-size:24px; background:#E3F2FD; padding:10px; border-radius:50%;">‚ú®</div>
                <div style="text-align:left;">
                    <span class="btn-label">Workout Generator</span>
                    <div style="font-size:12px; color:#888;">Let us pick for you</div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-manual" class="modal-overlay" onclick="closeModal('modal-manual')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Select Exercises</div><button class="btn-close" onclick="closeModal('modal-manual')">‚úï</button></div>
            
            <input type="text" id="search-input" class="search-bar" placeholder="Search exercises..." onkeyup="renderUnifiedList()">
            
            <div id="unified-list" class="unified-list">
                </div>

            <button onclick="openCustomModal()" class="btn-fab-add">+</button>
            <button class="btn-confirm-add" onclick="confirmManualAdd()">Add Selected</button>
        </div>
    </div>

    <div id="modal-custom" class="modal-overlay" onclick="closeModal('modal-custom')" style="align-items:center;">
        <div class="modal-content modal-content--auto" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">New Exercise</div><button class="btn-close" onclick="closeModal('modal-custom')">‚úï</button></div>
            <input type="text" id="custom-ex-input" placeholder="Exercise Name..." style="width:100%; padding:15px; margin-bottom:15px; border:1px solid #ddd; border-radius:12px;">
            <button class="btn-confirm-add" onclick="saveCustomExercise()">Add to List</button>
        </div>
    </div>

    <div id="modal-generator" class="modal-overlay" onclick="closeModal('modal-generator')">
        <div class="modal-content modal-content--auto" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Generator Settings</div><button class="btn-close" onclick="closeModal('modal-generator')">‚úï</button></div>
            
            <div style="margin-bottom:20px;">
                <div style="font-size:12px; color:#999; margin-bottom:5px; font-weight:700;">LOCATION</div>
                <div style="display:flex; gap:8px;">
                    <button id="gloc-home" class="btn-barcode" style="padding:10px 15px;" onclick="setGenLoc('home')">Home</button>
                    <button id="gloc-gym" class="btn-barcode" style="padding:10px 15px;" onclick="setGenLoc('gym')">Gym</button>
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <div style="font-size:12px; color:#999; margin-bottom:5px; font-weight:700;">FOCUS</div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <button class="btn-barcode" onclick="toggleFocus('upper', this)" style="padding:10px 15px;">Upper</button>
                    <button class="btn-barcode" onclick="toggleFocus('lower', this)" style="padding:10px 15px;">Lower</button>
                    <button class="btn-barcode" onclick="toggleFocus('core', this)" style="padding:10px 15px;">Core</button>
                    <button class="btn-barcode" onclick="toggleFocus('cardio', this)" style="padding:10px 15px;">Cardio</button>
                </div>
            </div>

            <div style="margin-bottom:20px;">
                <div style="font-size:12px; color:#999; margin-bottom:5px; font-weight:700;">QUANTITY: <span id="gen-val">4</span></div>
                <input type="range" id="gen-slider" min="2" max="8" value="4" style="width:100%;" oninput="document.getElementById('gen-val').innerText = this.value">
            </div>

            <button class="btn-confirm-add" onclick="previewGenerator()">Preview Workout</button>
        </div>
    </div>

    <div id="modal-preview" class="modal-overlay" onclick="closeModal('modal-preview')" style="align-items:center;">
        <div class="modal-content modal-content--auto" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Suggested Workout</div><button class="btn-close" onclick="closeModal('modal-preview')">‚úï</button></div>
            <div class="preview-card">
                <div>Here is a plan for you:</div>
                <div id="preview-list" class="preview-list"></div>
            </div>
            <button class="btn-confirm-add" onclick="acceptGenerator()">Start Workout</button>
        </div>
    </div>

    <div id="modal-user" class="modal-overlay" onclick="closeModal('modal-user')" style="align-items: center;">
        <div class="modal-content modal-content--auto" onclick="event.stopPropagation()">
            <div class="modal-header"><div class="modal-title">Select Team</div><button class="btn-close" onclick="closeModal('modal-user')">‚úï</button></div>
            <div style="display:grid; grid-template-columns: repeat(3,1fr); gap:10px;">
                <button class="btn-barcode" onclick="selectUser('Mami')" style="justify-content:center; padding:12px;">Mami</button>
                <button class="btn-barcode" onclick="selectUser('Papi')" style="justify-content:center; padding:12px;">Papi</button>
                <button class="btn-barcode" onclick="selectUser('Santi')" style="justify-content:center; padding:12px;">Santi</button>
                <button class="btn-barcode" onclick="selectUser('Fran')" style="justify-content:center; padding:12px;">Fran</button>
                <button class="btn-barcode" onclick="selectUser('Dana')" style="justify-content:center; padding:12px;">Dana</button>
                <button class="btn-barcode" onclick="selectUser('Matu')" style="justify-content:center; padding:12px;">Matu</button>
                <button class="btn-barcode" onclick="selectUser('Caro')" style="justify-content:center; padding:12px;">Caro</button>
                <button class="btn-barcode" onclick="selectUser('Sofi')" style="justify-content:center; padding:12px;">Sofi</button>
                <button class="btn-barcode" onclick="selectUser('Andi')" style="justify-content:center; padding:12px;">Andi</button>
                <button class="btn-barcode" onclick="selectUser('Meredith')" style="justify-content:center; padding:12px;">Meredith</button>
                <button class="btn-barcode" onclick="selectUser('Ceci')" style="justify-content:center; padding:12px;">Ceci</button>
                <button class="btn-barcode" onclick="document.getElementById('other-input').style.display='block'" style="justify-content:center; padding:12px;">Other</button>
            </div>
            <input type="text" id="other-input" placeholder="Guest Name..." style="display:none; width:100%; padding:15px; margin-top:15px; border:1px solid #ddd; border-radius:12px;">
        </div>
    </div>

    <div id="modal-barcode" class="modal-overlay" onclick="closeModal('modal-barcode')" style="align-items: flex-start; padding-top: 60px;">
        <div class="modal-content modal-content--auto" style="text-align:center; padding: 20px; margin: 0 auto;" onclick="event.stopPropagation()">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <div style="font-weight:700; font-size:16px;">Gym Pass</div>
                <button class="btn-close" style="width:30px; height:30px; font-size:16px;" onclick="closeModal('modal-barcode')">‚úï</button>
            </div>
            <img src="images/barcode.jpg" alt="Barcode" style="width:100%; max-height: 300px; object-fit:contain; border-radius:6px;">
        </div>
    </div>

<audio id="success-sound" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbx5yiTqUVvrzSQo8nNre09ksQKtn5U3DzDn_JXZkqyrIc_RFzniyaENNHTXgnodjCky/exec"; 
    const FAMILY_NAMES = ["Mami", "Papi", "Santi", "Fran", "Dana", "Matu", "Caro", "Sofi", "Andi", "Meredith", "Ceci"];

    // GLOBAL APP STATE
    let currentUser = null; 
    let dailyLog = [];
    let habitsData = { water: {c:0,g:8}, veggies: {c:0,g:5}, fruits: {c:0,g:5}, snacks: {c:0,g:2} };
    let isSubmitted = false; // "Locked" state
    
    // UI VARS
    let selectedBatch = new Set();
    let genLocation = 'home';
    let genFocus = new Set();
    let pendingPreview = []; // For Generator Preview

    // EXERCISE DATABASE
    const exerciseDB = [
        { name: "Running", type: "Cardio", loc: ["home", "gym"], img: "images/running.png" },
        { name: "Stationary Bike", type: "Cardio", loc: ["home", "gym"], img: "images/stationary-bike.png" },
        { name: "Push Ups", type: "Upper Body", loc: ["home", "gym"], img: "images/push-ups.png" },
        { name: "Bicep Curls", type: "Upper Body", loc: ["home", "gym"], img: "images/bicep-curls.png" },
        { name: "Shoulder Press", type: "Upper Body", loc: ["home", "gym"], img: "images/dumbbell-shoulder-press.png" },
        { name: "Lat Pulldown", type: "Upper Body", loc: ["gym"], img: "images/lat-pulldown.png" },
        { name: "Air Squats", type: "Lower Body", loc: ["home", "gym"], img: "images/air-squat.png" },
        { name: "Goblet Squat", type: "Lower Body", loc: ["home", "gym"], img: "images/goblet-squat.png" },
        { name: "Leg Press", type: "Lower Body", loc: ["gym"], img: "images/leg-press.png" },
        { name: "Plank", type: "Core", loc: ["home", "gym"], img: "images/plank.png" },
        { name: "Crunches", type: "Core", loc: ["home", "gym"], img: "images/crunches.png" },
        { name: "Hot Yoga", type: "Studio", loc: ["gym"], img: "images/yoga.png" },
        { name: "Pilates", type: "Studio", loc: ["home", "gym"], img: "images/pilates.png" }
    ];

    window.onload = function() {
        // Load customs
        const savedCustom = JSON.parse(localStorage.getItem('nogueraFit_custom') || '[]');
        savedCustom.forEach(ex => exerciseDB.push(ex));
        
        document.getElementById('today-date').innerText = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        const select = document.getElementById('dayInput');
        for (let i = 1; i <= 100; i++) { let opt = document.createElement('option'); opt.value = i; opt.innerHTML = i; select.appendChild(opt); }
        
        loadState();
        fetchFamilyData(); 
        updateProgressUI();
        initHabits();
        renderDashboard();
        updateCardState(); // Trigger visual state check
    }

    // --- CORE LOGIC: CARD STATES ---
    function updateCardState() {
        const card = document.getElementById('main-scorecard');
        const pill = document.getElementById('score-status-pill');
        const btn = document.getElementById('btn-submit');
        const lockedMsg = document.getElementById('msg-locked');
        const actionArea = document.getElementById('action-area');
        
        // Reset classes
        card.classList.remove('state-empty', 'state-active', 'state-submitted');
        
        // LOGIC
        const hasActivity = dailyLog.length > 0 || habitsData.water.c > 0 || habitsData.veggies.c > 0 || habitsData.fruits.c > 0 || habitsData.snacks.c > 0;

        if (isSubmitted) {
            // STATE: SUBMITTED (LOCKED)
            card.classList.add('state-submitted');
            pill.innerText = "Submitted";
            btn.style.display = 'none';
            lockedMsg.style.display = 'block';
            actionArea.classList.add('hidden');
        } else if (hasActivity) {
            // STATE: ACTIVE (DRAFT)
            card.classList.add('state-active');
            pill.innerText = "In Progress";
            btn.style.display = 'block';
            lockedMsg.style.display = 'none';
            actionArea.classList.remove('hidden');
        } else {
            // STATE: EMPTY
            card.classList.add('state-empty');
            pill.innerText = "Empty";
            btn.style.display = 'none';
            lockedMsg.style.display = 'none';
            actionArea.classList.remove('hidden');
        }
    }

    function submitScorecard() {
        if (!currentUser) { alert("Please select your name first!"); openUserModal(); return; }
        
        if(confirm("Ready to finish the day?")) {
            isSubmitted = true;
            saveState();
            updateCardState();
            
            // Sync to Cloud
            const h = habitsData;
            const habitStr = `W:${h.water.c}, V:${h.veggies.c}, F:${h.fruits.c}, S:${h.snacks.c}`;
            const workoutStr = dailyLog.length > 0 ? dailyLog.map(i => i.name).join(", ") : "Rest Day";
            
            const payload = {
                date: new Date().toLocaleString(),
                day: document.getElementById('dayInput').value,
                name: currentUser,
                location: 'app',
                workout: workoutStr + " | " + habitStr
            };
            
            document.getElementById('success-sound').play().catch(()=>{});
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.5 } });

            fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(err => console.log(err));
        }
    }

    function unlockDay() {
        if(confirm("Need to add something? This will unlock your scorecard.")) {
            isSubmitted = false;
            saveState();
            updateCardState();
        }
    }

    // --- DASHBOARD UI ---
    function renderDashboard() {
        const list = document.getElementById('today-log-list');
        list.innerHTML = '';

        if (dailyLog.length === 0) {
            list.innerHTML = `<div style="text-align:center; color:#CCC; padding:20px; font-size:14px;">No exercises logged yet.</div>`;
        } else {
            dailyLog.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'log-item';
                div.innerHTML = `
                    <div class="log-left"><span class="log-check">‚úÖ</span> <span>${item.name}</span></div>
                    <button class="btn-delete-log" onclick="removeLogItem(${idx})">‚úï</button>
                `;
                list.appendChild(div);
            });
        }
        
        document.getElementById('score-workout').innerText = dailyLog.length + " Done";
        if(dailyLog.length > 0) document.getElementById('score-workout').classList.add('done');
    }

    function removeLogItem(idx) {
        if(isSubmitted) return; // double check
        dailyLog.splice(idx, 1);
        saveState();
        renderDashboard();
        updateCardState();
    }

    // --- MANUAL LOG LOGIC (Unified List) ---
    function startManualLog() {
        closeModal('modal-wizard');
        document.getElementById('modal-manual').style.display = 'flex';
        selectedBatch.clear();
        renderUnifiedList();
    }

    function renderUnifiedList() {
        const container = document.getElementById('unified-list');
        container.innerHTML = '';
        const search = document.getElementById('search-input').value.toLowerCase();
        
        // Group by Type
        const grouped = {};
        exerciseDB.forEach(ex => {
            if(!grouped[ex.type]) grouped[ex.type] = [];
            grouped[ex.type].push(ex);
        });

        Object.keys(grouped).forEach(type => {
            // Filter items in this group
            const filtered = grouped[type].filter(ex => ex.name.toLowerCase().includes(search));
            if(filtered.length === 0) return;

            // Render Header
            const header = document.createElement('div');
            header.className = 'list-section-header';
            header.innerText = type;
            container.appendChild(header);

            // Render Items
            filtered.forEach(ex => {
                const div = document.createElement('div');
                div.className = 'select-item';
                if(selectedBatch.has(ex.name)) div.classList.add('selected');
                
                div.innerHTML = `
                    <div class="item-left">
                        <img src="${ex.img || 'images/icon.png'}" class="item-img" onError="this.style.display='none'">
                        <span style="font-weight:600;">${ex.name}</span>
                    </div>
                    <div class="item-check-circle"></div>
                `;
                div.onclick = () => {
                    if(selectedBatch.has(ex.name)) selectedBatch.delete(ex.name); else selectedBatch.add(ex.name);
                    renderUnifiedList(); // Re-render to update checkmarks
                    document.querySelector('#modal-manual .btn-confirm-add').innerText = `Add ${selectedBatch.size} Exercises`;
                };
                container.appendChild(div);
            });
        });
    }

    function openCustomModal() { document.getElementById('modal-custom').style.display = 'flex'; }
    
    function saveCustomExercise() {
        const val = document.getElementById('custom-ex-input').value.trim();
        if(!val) return;
        const newEx = { name: val, type: 'Custom', loc: ['home'], img: '' };
        exerciseDB.push(newEx);
        
        // Persist
        const saved = JSON.parse(localStorage.getItem('nogueraFit_custom') || '[]');
        saved.push(newEx);
        localStorage.setItem('nogueraFit_custom', JSON.stringify(saved));

        closeModal('modal-custom');
        selectedBatch.add(val);
        renderUnifiedList();
    }

    function confirmManualAdd() {
        selectedBatch.forEach(name => dailyLog.push({ name: name }));
        saveState();
        renderDashboard();
        updateCardState();
        closeModal('modal-manual');
    }

    // --- GENERATOR LOGIC (Preview Flow) ---
    function startGenerator() {
        closeModal('modal-wizard');
        document.getElementById('modal-generator').style.display = 'flex';
    }

    function setGenLoc(l) { genLocation = l; document.querySelectorAll('#modal-generator button').forEach(b => { if(b.innerText.toLowerCase()===l) b.style.backgroundColor='#007AFF'; else b.style.backgroundColor='white'; }); }
    
    function toggleFocus(f, b) { 
        if(genFocus.has(f)){ genFocus.delete(f); b.style.backgroundColor='white'; b.style.color='#555'; }
        else { genFocus.add(f); b.style.backgroundColor='#007AFF'; b.style.color='white'; } 
    }

    function previewGenerator() {
        const count = parseInt(document.getElementById('gen-slider').value);
        if(genFocus.size===0) { alert("Select focus!"); return; }
        
        let pool = exerciseDB.filter(ex => {
            const locMatch = ex.loc.includes(genLocation) || ex.loc.includes('home'); // loose match
            return locMatch && genFocus.has(ex.type.toLowerCase().split(' ')[0]);
        });

        if(pool.length === 0) pool = exerciseDB; // fallback
        pool.sort(() => 0.5 - Math.random());
        pendingPreview = pool.slice(0, count);

        // Show Preview Modal
        closeModal('modal-generator');
        const list = document.getElementById('preview-list');
        list.innerHTML = '';
        pendingPreview.forEach(ex => {
            list.innerHTML += `<div class="preview-item"><span>üîπ</span> ${ex.name}</div>`;
        });
        document.getElementById('modal-preview').style.display = 'flex';
    }

    function acceptGenerator() {
        pendingPreview.forEach(ex => dailyLog.push({name: ex.name}));
        saveState();
        renderDashboard();
        updateCardState();
        closeModal('modal-preview');
    }

    // --- HABITS ---
    function initHabits() {
        document.querySelectorAll('.circle-row').forEach(row => {
            const h = row.getAttribute('data-habit');
            const g = parseInt(row.getAttribute('data-goal'));
            row.innerHTML = ''; 
            for(let i=0; i<g; i++) {
                const d = document.createElement('div');
                d.className = 'habit-circle';
                d.onclick = () => {
                    if(isSubmitted) return;
                    const cVal = habitsData[h].c;
                    const nVal = (cVal === i+1 && i===0) ? 0 : i+1;
                    habitsData[h].c = nVal;
                    updateHabitVisuals(h, g, nVal);
                    saveState();
                    updateCardState();
                };
                row.appendChild(d);
            }
            updateHabitVisuals(h, g, habitsData[h].c);
        });
    }

    function updateHabitVisuals(h, g, val) {
        const row = document.querySelector(`.circle-row[data-habit="${h}"]`);
        const colors = { water: '#5AC8FA', veggies: '#34C759', fruits: '#FF3B30', snacks: '#AF52DE' };
        Array.from(row.children).forEach((c, i) => {
            if (i < val) { c.classList.add('active'); c.style.background = colors[h]; } 
            else { c.classList.remove('active'); c.style.background = 'transparent'; }
        });
        document.getElementById(`count-${h}`).innerText = `${val}/${g}`;
        
        const mainEl = document.getElementById(`score-${h}`);
        mainEl.innerText = `${val} / ${g}`;
        if(val >= g) mainEl.classList.add('done'); else mainEl.classList.remove('done');
    }

    // --- STATE MANAGEMENT ---
    function saveState() {
        const data = {
            date: new Date().toDateString(),
            day: document.getElementById('dayInput').value,
            log: dailyLog,
            habits: habitsData,
            user: currentUser,
            submitted: isSubmitted
        };
        localStorage.setItem('nogueraFit_v2', JSON.stringify(data));
    }

    function loadState() {
        const raw = localStorage.getItem('nogueraFit_v2');
        if (!raw) return;
        const saved = JSON.parse(raw);
        if (saved.date === new Date().toDateString()) {
            document.getElementById('dayInput').value = saved.day;
            dailyLog = saved.log || [];
            habitsData = saved.habits || habitsData;
            isSubmitted = saved.submitted || false;
        }
        if (saved.user) {
            currentUser = saved.user;
            document.getElementById('header-username').innerText = "üë§ " + saved.user;
        }
    }

    // --- LEADERBOARD & UTILS ---
    async function fetchFamilyData() {
        try {
            const res = await fetch(API_URL);
            const raw = await res.json();
            const cont = document.getElementById('lb-container');
            cont.innerHTML = '';
            
            const list = FAMILY_NAMES.map(name => {
                const found = raw.find(r => r.name === name);
                return found || { name: name, streak: 0 };
            }).sort((a,b) => b.streak - a.streak);
            
            list.forEach((u, idx) => {
                const isMe = (u.name === currentUser);
                const nameStyle = isMe ? 'color: var(--ios-blue);' : 'color: #1C1C1E;';
                const suffix = isMe ? ' <span style="font-size:12px; color:#999;">(You)</span>' : '';
                let rC = 'rank-low'; if(idx===0) rC='rank-1'; if(idx===1) rC='rank-2'; if(idx===2) rC='rank-3';
                
                cont.innerHTML += `
                    <div class="lb-row">
                        <div style="display:flex; align-items:center;">
                            <div class="lb-rank ${rC}">${idx+1}</div>
                            <div style="font-weight:700; font-size:15px; ${nameStyle}">${u.name}${suffix}</div>
                        </div>
                        <div style="font-weight:700;">${u.streak}</div>
                    </div>`;
            });
        } catch(e) {}
    }

    function selectUser(name) { currentUser = name; document.getElementById('header-username').innerText = "üë§ " + name; closeModal('modal-user'); saveState(); fetchFamilyData(); }
    function updateProgressUI() { const d = document.getElementById('dayInput').value; document.getElementById('visual-progress').style.width = d + '%'; document.getElementById('progress-text').innerText = d + '%'; }
    function openWorkoutWizard() { document.getElementById('modal-wizard').style.display = 'flex'; }
    function openNutritionModal() { document.getElementById('modal-nutrition').style.display = 'flex'; }
    function openBarcode() { document.getElementById('modal-barcode').style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

</script>
</body>
</html>
